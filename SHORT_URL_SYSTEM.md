# Short URL System - Implementation Summary

## Overview

Personalized short URL system for wedding invitations with format: `/{code}/{names}`

**Example URLs:**
- `http://localhost:3000/kkd/1111y333` → Redirects to invitation
- `http://localhost:3000/tsk/RobertyCarlos` → Redirects to invitation
- `http://localhost:3000/fdg/Ss` → Redirects to invitation

## Key Features

### 1. **Ultra-Short URLs**
- **Format**: `/{3-4 char code}/{sanitized names}`
- **Code Generation**: Base36 (lowercase letters + digits)
- **Uniqueness**: Database collision detection with fallback to 4-char codes
- **Case-Insensitive**: `fdg/ss`, `FDG/SS`, `fdg/Ss` all work

### 2. **Name Sanitization**
- **Removes Accents**: María → Maria, José → Jose
- **Removes Spaces**: José Luis → Joseluis
- **Removes Special Chars**: O'Connor → Oconnor
- **Keeps Numbers**: XV15 → Xv15, 11 → 11
- **Separator**: Uses `y` instead of `&` to avoid URL encoding issues

**Why 'y' instead of '&'?**
The `&` character is a special character in URLs (query parameter separator). Using `&` causes:
- URL encoding problems (`%26`, `%2526` double-encoding)
- Browser parsing issues (breaks URLs)
- Harder to share and remember

Using `y` (Spanish "and") solves all these issues while remaining natural for Spanish-speaking users.

### 3. **ShareURLModal UI**

Compact modal with two options:

#### **Opción Básica**
- Copy normal URL directly: `/invitacion/{url_slug}`
- Always available, no unlock needed

#### **Opción Premium**
- Shows random preview before generation (NOT saved)
- Preview regenerates on each modal open
- Click "Desbloquear" to generate and save to database
- Names auto-generated from `groom_name` and `bride_name` (read-only)
- Once generated, shows "Copiar" button

## Architecture

### Backend

#### Database Schema
```sql
-- New columns in invitations table
short_code VARCHAR(10) UNIQUE,          -- e.g., "w3d", "xv2"
custom_names VARCHAR(100),              -- e.g., "CarlosyMaria", "1111y333"
```

#### API Endpoints

**Generate Short URL**
```
POST /api/invitations/{id}/generate-short-url
Body: { "custom_names": "CarlosyMaria" } (optional)
Response: { "success": true, "short_code": "w3d", "custom_names": "CarlosyMaria", "short_url": "w3d/CarlosyMaria" }
```

**Get Existing Short URL**
```
GET /api/invitations/{id}/short-url
Response: { "exists": true, "short_code": "w3d", "custom_names": "CarlosyMaria", "short_url": "w3d/CarlosyMaria" }
```

**Resolve Short URL (for Next.js SSR)**
```
GET /api/short-url/redirect?code=w3d&names=CarlosyMaria
Response: { "success": true, "url_slug": "abc123", "invitation_id": 60 }
```

#### Files
- `backend/models/invitation.py` - Added `short_code` and `custom_names` columns
- `backend/utils/short_url_generator.py` - Core utilities for code generation and sanitization
- `backend/api/short_urls.py` - API endpoints
- `backend/test_short_urls.py` - Comprehensive test suite
- `backend/migrate_short_urls.py` - Migration script for existing data

### Frontend

#### Next.js Dynamic Route
```
frontend/src/app/[code]/[names]/page.tsx
```

**How it works:**
1. User visits: `http://localhost:3000/kkd/1111y333`
2. Next.js captures: `{ code: "kkd", names: "1111y333" }`
3. Server-side fetch to backend API: `/api/short-url/redirect?code=kkd&names=1111y333`
4. Backend responds with `url_slug`
5. Server-side redirect to: `/invitacion/{url_slug}`

**Why Server-Side?**
- SEO-friendly redirects
- No loading flash
- Works without JavaScript
- Better for social media sharing

#### ShareURLModal Component
```
frontend/src/components/account/invitations/ShareURLModal.tsx
```

**Key Logic:**
```typescript
// Preview: Random code + auto-generated names (NOT saved)
const premiumUrl = shortUrlData
  ? `${window.location.origin}/${shortUrlData.short_url}`  // Real (saved)
  : `${window.location.origin}/${exampleCode}/${autoGeneratedNames}`;  // Preview

// Auto-generate names (read-only)
const autoGeneratedNames = (() => {
  const { groom_name, bride_name } = invitation;
  if (groom_name && bride_name) {
    return `${groom_name}y${bride_name}`;  // Using 'y'
  }
  return groom_name || bride_name || 'Invitacion';
})();
```

#### Files
- `frontend/src/app/[code]/[names]/page.tsx` - Dynamic route handler
- `frontend/src/components/account/invitations/ShareURLModal.tsx` - UI component
- `frontend/src/lib/api/invitations.ts` - API client functions
- `frontend/src/lib/api.ts` - Updated Invitation interface

## Testing

### Run Full Test Suite
```bash
cd backend
python test_short_urls.py
```

**Tests:**
1. Backend resolution (exact, lowercase, uppercase, not found)
2. Name sanitization (numbers, accents, couples)
3. Frontend route existence

### Manual Testing

**Test Backend Resolution:**
```bash
curl -s "http://localhost:5000/api/short-url/redirect?code=kkd&names=1111y333"
# Should return: {"success": true, "url_slug": "...", "invitation_id": 58}
```

**Test Frontend Route:**
```bash
# Visit in browser:
http://localhost:3000/kkd/1111y333
# Should redirect to invitation page
```

**Test Modal UI:**
1. Login to `/mi-cuenta/invitaciones`
2. Click "Copiar URL" on any invitation
3. Verify "Opción Premium" shows random preview
4. Click "Desbloquear" to generate
5. Verify generated URL uses `y` separator

## Migration

### Migrate Existing Data

If you have invitations with old `&` separator:

```bash
cd backend
python migrate_short_urls.py
```

**What it does:**
- Finds all invitations with `short_code` and `custom_names`
- Replaces `&` with `y` in `custom_names` column
- Shows before/after for each update
- Lists all short URLs after migration

**Example Output:**
```
[UPDATE] ID 58: '1111&333' -> '1111y333'
[UPDATE] ID 61: 'Robert&Carlos' -> 'RobertyCarlos'
[SUCCESS] Updated 2 invitation(s)
```

## URL Examples

### Sanitization Examples

| Input Names | Output | URL |
|------------|--------|-----|
| Carlos, María | CarlosyMaria | `/w3d/CarlosyMaria` |
| José Luis, Ana | JoseluisyAna | `/abc/JoseluisyAna` |
| 1111, 333 | 1111y333 | `/kkd/1111y333` |
| XV 15, - | Xv15 | `/xyz/Xv15` |
| Robert, Carlos | RobertyCarlos | `/tsk/RobertyCarlos` |

### Case-Insensitive Matching

All these URLs work for the same invitation:
- `http://localhost:3000/fdg/Ss`
- `http://localhost:3000/FDG/SS`
- `http://localhost:3000/fdg/ss`
- `http://localhost:3000/FDG/ss`

## Code Generation Stats

### 3-Character Codes
- **Combinations**: 36³ = 46,656
- **Format**: `[a-z0-9]{3}`
- **Examples**: `w3d`, `abc`, `xyz`, `123`

### 4-Character Codes (Fallback)
- **Combinations**: 36⁴ = 1,679,616
- **Format**: `[a-z0-9]{4}`
- **Examples**: `w3d5`, `abcd`, `xyz9`

### Collision Handling
1. Try 50 attempts with 3-char codes
2. If exhausted, try 50 attempts with 4-char codes
3. Raises exception if all attempts fail (extremely rare)

## Benefits

### For Users
✅ **Memorable**: Short, easy to type
✅ **Shareable**: Works in SMS, WhatsApp, social media
✅ **Professional**: Clean, branded URLs
✅ **Personalized**: Contains couple names
✅ **No Special Characters**: No encoding issues

### For Developers
✅ **SEO-Friendly**: Server-side redirects
✅ **Case-Insensitive**: Better UX
✅ **Collision-Proof**: Automatic fallback
✅ **Well-Tested**: Comprehensive test suite
✅ **Easy Migration**: One-command migration script

## Security Considerations

### Database Uniqueness
- `short_code` has UNIQUE constraint
- Collision detection before saving
- Transaction-safe generation

### URL Validation
- Input sanitization prevents XSS
- Case-insensitive search prevents bypass
- 404 for invalid codes

### Privacy
- Short URLs don't expose invitation IDs
- Random codes are unpredictable
- No user information in URLs

## Future Enhancements

### Potential Features
- [ ] QR code generation for short URLs
- [ ] Analytics tracking (click counts, locations)
- [ ] Custom short codes (user-defined)
- [ ] Expiration dates for short URLs
- [ ] URL preview before redirect

### Performance Optimizations
- [ ] Cache frequently accessed short URLs
- [ ] Database indexing on `short_code` and `custom_names`
- [ ] CDN integration for global access

## Troubleshooting

### Issue: 404 Redirect to Home

**Symptoms**: Accessing short URL redirects to home page

**Causes:**
1. Backend not running
2. Database connection issue
3. Invitation not found
4. Duplicate `/api` in URL path

**Solutions:**
```bash
# Check backend is running
curl http://localhost:5000/health

# Test backend resolution
curl "http://localhost:5000/api/short-url/redirect?code=XXX&names=YYY"

# Check database
cd backend && python -c "from app import create_app; ..."
```

### Issue: Double URL Encoding

**Symptoms**: Backend receives `%2526` instead of `&`

**Cause**: Next.js auto-decodes route params, then `encodeURIComponent()` re-encodes

**Solution**: Keep `encodeURIComponent(names)` in query string (this is correct)

### Issue: Special Characters in URL

**Symptoms**: URLs break with `&` character

**Cause**: `&` is URL special character (query param separator)

**Solution**: Use `y` separator instead (already implemented)

## Support

### Documentation
- This file: `SHORT_URL_SYSTEM.md`
- Backend tests: `backend/test_short_urls.py`
- Migration script: `backend/migrate_short_urls.py`
- Integration guide: `docs/secciones/GUIA_REGISTRO_NUEVAS_SECCIONES.md`

### Key Files to Review
```
Backend:
- backend/models/invitation.py (lines 43-53, 159-170)
- backend/utils/short_url_generator.py (entire file)
- backend/api/short_urls.py (entire file)

Frontend:
- frontend/src/app/[code]/[names]/page.tsx (entire file)
- frontend/src/components/account/invitations/ShareURLModal.tsx (lines 49-60)
- frontend/src/lib/api/invitations.ts (generateShortUrl, getShortUrl functions)
```

## Changelog

### 2025-10-12 - Initial Implementation
- ✅ Added `short_code` and `custom_names` database columns
- ✅ Implemented code generation with collision handling
- ✅ Created sanitization utilities
- ✅ Built API endpoints (generate, get, resolve)
- ✅ Created Next.js dynamic route for redirects
- ✅ Designed ShareURLModal with unlock mechanism
- ✅ Changed separator from `&` to `y` to avoid URL issues
- ✅ Created migration script for existing data
- ✅ Added comprehensive test suite
- ✅ Updated frontend to use `y` separator in previews

---

**System Status**: ✅ **FULLY OPERATIONAL**

All tests passing. Migration complete. Ready for production use.
