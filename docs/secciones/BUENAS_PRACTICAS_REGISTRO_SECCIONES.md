# üìã **GU√çA COMPLETA: BUENAS PR√ÅCTICAS PARA REGISTRO DE SECCIONES**

**Versi√≥n:** 2.0.0
**Fecha:** 24 de Enero, 2025
**Sistema:** invitation_sections_data - Analytics y Variables
**Autor:** Sistema de Documentaci√≥n T√©cnica

---

## **üéØ OBJETIVO DE ESTA GU√çA**

Esta documentaci√≥n establece las **mejores pr√°cticas** para el registro correcto de datos en el sistema de secciones optimizado `invitation_sections_data`. Garantiza:

- ‚úÖ **Consistencia** en el formato de datos
- ‚úÖ **Integridad** referencial y de datos
- ‚úÖ **Performance** optimizado para analytics
- ‚úÖ **Escalabilidad** del sistema
- ‚úÖ **Trazabilidad** completa para business intelligence

---

## **üìä ARQUITECTURA DEL SISTEMA**

### **TABLA PRINCIPAL: `invitation_sections_data`**

```sql
CREATE TABLE invitation_sections_data (
    id INT AUTO_INCREMENT PRIMARY KEY,

    -- TRACKING DE NEGOCIO (OBLIGATORIOS)
    invitation_id INT NOT NULL,        -- FK a invitations
    user_id INT NOT NULL,              -- FK a users (analytics por cliente)
    order_id INT,                      -- FK a orders (analytics por orden)
    plan_id INT NOT NULL,              -- FK a plans (analytics por plan)

    -- ORGANIZACI√ìN POR SECCI√ìN (OBLIGATORIOS)
    section_type VARCHAR(50) NOT NULL,     -- 'hero', 'gallery', 'story'
    section_variant VARCHAR(20) NOT NULL,  -- 'hero_1', 'hero_2'
    category VARCHAR(50) DEFAULT 'weddings', -- 'weddings', 'kids', 'corporate'

    -- CONTENIDO (OBLIGATORIO)
    variables_json JSON NOT NULL,          -- Variables de la secci√≥n
    variables_count INT GENERATED AS (JSON_LENGTH(variables_json)) STORED,

    -- METADATA (OPCIONALES)
    usage_stats JSON,                      -- Estad√≠sticas de uso
    last_modified DATETIME DEFAULT NOW() ON UPDATE NOW(),
    created_at DATETIME DEFAULT NOW()
);
```

---

## **üìù LLENADO CORRECTO DE CADA COLUMNA**

### **1. CAMPOS DE TRACKING DE NEGOCIO**

#### **`invitation_id` (INT, NOT NULL)**
- **Prop√≥sito:** Identificador √∫nico de la invitaci√≥n
- **Origen:** Tabla `invitations.id`
- **Validaci√≥n:** DEBE existir en tabla `invitations`

```sql
-- ‚úÖ CORRECTO
INSERT INTO invitation_sections_data (invitation_id, ...)
VALUES (123, ...);

-- ‚ùå INCORRECTO
INSERT INTO invitation_sections_data (invitation_id, ...)
VALUES (NULL, ...);  -- No puede ser NULL
```

#### **`user_id` (INT, NOT NULL)**
- **Prop√≥sito:** Identificador del cliente (para analytics)
- **Origen:** Tabla `users.id`
- **Uso Analytics:** Patrones de uso por cliente, segmentaci√≥n
- **Validaci√≥n:** DEBE existir en tabla `users`

```python
# ‚úÖ CORRECTO - Obtener user_id de la invitaci√≥n
invitation = Invitation.query.get(invitation_id)
user_id = invitation.user_id

# ‚ùå INCORRECTO - Hardcodear o usar NULL
user_id = None  # Incorrecto
```

#### **`order_id` (INT, NULLABLE)**
- **Prop√≥sito:** Identificador de la orden de compra
- **Origen:** Tabla `orders.id`
- **Uso Analytics:** ROI por orden, conversion tracking
- **Validaci√≥n:** Si provisto, DEBE existir en tabla `orders`

```python
# ‚úÖ CORRECTO - Puede ser None para invitaciones gratuitas
order_id = invitation.order_id  # Puede ser None

# ‚úÖ CORRECTO - Validar si se provee
if order_id and not Order.query.get(order_id):
    raise ValueError(f"Order {order_id} no existe")
```

#### **`plan_id` (INT, NOT NULL)**
- **Prop√≥sito:** Plan de suscripci√≥n del cliente
- **Origen:** Tabla `plans.id`
- **Uso Analytics:** An√°lisis de features por plan, upselling
- **Validaci√≥n:** DEBE existir en tabla `plans`

```python
# ‚úÖ CORRECTO - Obtener de invitaci√≥n o usuario
plan_id = invitation.plan_id or user.current_plan_id

# ‚ùå INCORRECTO
plan_id = 1  # Hardcodear sin validaci√≥n
```

### **2. CAMPOS DE ORGANIZACI√ìN**

#### **`section_type` (VARCHAR(50), NOT NULL)**
- **Prop√≥sito:** Tipo de secci√≥n (hero, gallery, etc.)
- **Formato:** snake_case, solo letras y guiones bajos
- **Valores V√°lidos:** Ver secci√≥n "Tipos de Secciones V√°lidos"

```python
# ‚úÖ CORRECTO
section_type = "hero"
section_type = "place_ceremonia"
section_type = "birthday_child"

# ‚ùå INCORRECTO
section_type = "Hero"              # No CamelCase
section_type = "place-ceremonia"   # No guiones
section_type = "place ceremonia"   # No espacios
section_type = ""                  # No vac√≠o
```

#### **`section_variant` (VARCHAR(20), NOT NULL)**
- **Prop√≥sito:** Variante espec√≠fica de la secci√≥n
- **Formato:** `{section_type}_{numero}`
- **Numeraci√≥n:** Empezar desde 1

```python
# ‚úÖ CORRECTO
section_variant = "hero_1"
section_variant = "hero_2"
section_variant = "gallery_1"

# ‚ùå INCORRECTO
section_variant = "hero"           # Falta n√∫mero
section_variant = "hero_0"         # No empezar desde 0
section_variant = "Hero_1"         # No CamelCase
```

#### **`category` (VARCHAR(50), DEFAULT 'weddings')**
- **Prop√≥sito:** Categor√≠a del template/evento
- **Valores V√°lidos:** 'weddings', 'kids', 'corporate', 'quinceanos', 'baby_shower'

```python
# ‚úÖ CORRECTO
category = "weddings"    # Default
category = "kids"
category = "corporate"

# ‚ùå INCORRECTO
category = "wedding"     # Singular incorrecto
category = "Wedding"     # No CamelCase
category = "bodas"       # En ingl√©s solamente
```

### **3. CAMPO DE CONTENIDO**

#### **`variables_json` (JSON, NOT NULL)**
- **Prop√≥sito:** Almacena todas las variables de la secci√≥n
- **Formato:** Objeto JSON v√°lido
- **Estructura:** Flat object (no nested excesivo)
- **Encoding:** UTF-8 para caracteres especiales

```python
# ‚úÖ CORRECTO - Estructura plana y consistente
variables_json = {
    "groom_name": "Eduardo",
    "bride_name": "Mar√≠a",
    "weddingDate": "2025-08-15T17:00:00",
    "eventLocation": "Lima, Per√∫",
    "heroImageUrl": "https://example.com/image.jpg",
    "custom_colors": {
        "primary": "#D4AF37",
        "secondary": "#FFFFFF"
    }
}

# ‚ùå INCORRECTO - Nested excesivo o inconsistente
variables_json = {
    "data": {
        "couple": {
            "groom": {
                "personal": {
                    "name": "Eduardo"  # Demasiado nested
                }
            }
        }
    }
}
```

**Reglas para `variables_json`:**

1. **Nombres de variables:** camelCase o snake_case consistente
2. **Fechas:** Formato ISO 8601 (`YYYY-MM-DDTHH:mm:ss`)
3. **URLs:** URLs completas con protocolo
4. **Colores:** Formato hexadecimal (#RRGGBB)
5. **Booleanos:** `true`/`false` (JSON v√°lido)
6. **Arrays:** Para listas de elementos similares

```python
# ‚úÖ EJEMPLOS CORRECTOS POR TIPO DE DATO

# Fechas
"weddingDate": "2025-08-15T17:00:00"
"birthdayDate": "2025-03-20"

# URLs
"heroImageUrl": "https://cdn.example.com/images/hero.jpg"
"videoUrl": "https://www.youtube.com/embed/abc123"

# Colores
"backgroundColor": "#FFB6C1"
"primary_color": "#D4AF37"

# Booleanos
"is_enabled": true
"show_ceremony": false

# Arrays
"gallery_images": [
    {"id": 1, "url": "img1.jpg", "alt": "Descripci√≥n"},
    {"id": 2, "url": "img2.jpg", "alt": "Descripci√≥n"}
]

# N√∫meros
"age": 25
"guest_count": 150
"duration_minutes": 120
```

### **4. CAMPOS DE METADATA**

#### **`usage_stats` (JSON, NULLABLE)**
- **Prop√≥sito:** Estad√≠sticas y metadata para analytics
- **Formato:** Objeto JSON con estructura predefinida

```python
# ‚úÖ ESTRUCTURA RECOMENDADA
usage_stats = {
    "created_at": "2025-01-24T10:30:00",
    "last_edited": "2025-01-24T15:45:00",
    "edit_count": 5,
    "source": "frontend_editor",  # frontend_editor, api, migration, script
    "editor_version": "2.1.0",
    "client_info": {
        "ip": "192.168.1.100",
        "user_agent": "Mozilla/5.0...",
        "country": "PE"
    },
    "feature_flags": {
        "premium_colors": true,
        "video_background": false
    },
    "performance": {
        "load_time_ms": 245,
        "save_time_ms": 89
    }
}
```

---

## **üìö TIPOS DE SECCIONES V√ÅLIDOS**

### **WEDDING CATEGORY**

| **Section Type** | **Descripci√≥n** | **Variantes** | **Variables T√≠picas** |
|------------------|-----------------|---------------|---------------------|
| `hero` | Secci√≥n principal con nombres y fecha | hero_1, hero_2, hero_3 | groom_name, bride_name, weddingDate |
| `welcome` | Mensaje de bienvenida | welcome_1, welcome_2 | welcome_title, welcome_description |
| `couple` | Informaci√≥n de la pareja | couple_1 | couple_bride_name, couple_groom_name |
| `story` | Historia de amor en momentos | story_1 | story_moment_1_date, story_moment_1_title |
| `gallery` | Galer√≠a de fotos | gallery_1, gallery_2 | gallery_images, sectionTitle |
| `video` | Video de la pareja | video_1 | video_videoEmbedUrl, video_title |
| `countdown` | Contador regresivo | countdown_1 | countdown_title, weddingDate |
| `itinerary` | Programa del d√≠a | itinerary_1 | itinerary_event_ceremonia_time |
| `place_religioso` | Ceremonia religiosa | place_religioso_1 | place_religioso_lugar, place_religioso_direccion |
| `place_ceremonia` | Recepci√≥n/fiesta | place_ceremonia_1 | place_ceremonia_lugar, place_ceremonia_hora |
| `vestimenta` | C√≥digo de vestimenta | vestimenta_1 | vestimenta_etiqueta, vestimenta_no_colores_info |
| `familiares` | Familia y padrinos | familiares_1 | familiares_padre_novio, familiares_madre_novia |
| `footer` | Pie de p√°gina | footer_1 | footer_copyrightText |

### **KIDS CATEGORY**

| **Section Type** | **Descripci√≥n** | **Variantes** | **Variables T√≠picas** |
|------------------|-----------------|---------------|---------------------|
| `party_hero` | H√©roe de fiesta infantil | party_hero_1 | childName, age, birthdayDate |
| `birthday_child` | Info del cumplea√±ero | birthday_child_1 | childNickname, favoriteColor |
| `party_games` | Juegos y actividades | party_games_1 | game1Name, game1Description |
| `party_info` | Informaci√≥n pr√°ctica | party_info_1 | partyDate, partyTime, partyAddress |

---

## **üîÑ FLUJO DE REGISTRO CORRECTO**

### **PASO 1: VALIDACI√ìN PREVIA**

```python
def validate_section_data(invitation_id, user_id, order_id, plan_id,
                         section_type, section_variant, category, variables_json):
    """Validar datos antes del registro"""

    # 1. Validar que invitation existe
    invitation = Invitation.query.get(invitation_id)
    if not invitation:
        raise ValueError(f"Invitation {invitation_id} no existe")

    # 2. Validar que user_id coincide con la invitaci√≥n
    if invitation.user_id != user_id:
        raise ValueError(f"User {user_id} no es owner de invitation {invitation_id}")

    # 3. Validar plan_id
    if not Plan.query.get(plan_id):
        raise ValueError(f"Plan {plan_id} no existe")

    # 4. Validar section_type
    if not is_valid_section_type(section_type, category):
        raise ValueError(f"Section type '{section_type}' no v√°lido para category '{category}'")

    # 5. Validar JSON
    if not isinstance(variables_json, dict):
        raise ValueError("variables_json debe ser un objeto JSON v√°lido")

    # 6. Validar que no existe duplicado
    existing = InvitationSectionsData.query.filter_by(
        invitation_id=invitation_id,
        section_type=section_type
    ).first()

    if existing:
        raise ValueError(f"Secci√≥n '{section_type}' ya existe para invitation {invitation_id}")

    return True
```

### **PASO 2: REGISTRO CON TRANSACCI√ìN**

```python
def create_section_safely(invitation_id, user_id, order_id, plan_id,
                         section_type, section_variant, category, variables_json,
                         usage_stats=None):
    """Crear secci√≥n de manera segura con transacci√≥n"""

    try:
        # Validar datos
        validate_section_data(invitation_id, user_id, order_id, plan_id,
                            section_type, section_variant, category, variables_json)

        # Generar usage_stats si no se provee
        if not usage_stats:
            usage_stats = {
                "created_at": datetime.now().isoformat(),
                "source": "api_create",
                "initial_variables_count": len(variables_json)
            }

        # Crear registro
        section = InvitationSectionsData(
            invitation_id=invitation_id,
            user_id=user_id,
            order_id=order_id,
            plan_id=plan_id,
            section_type=section_type,
            section_variant=section_variant,
            category=category,
            variables_json=variables_json,
            usage_stats=usage_stats
        )

        db.session.add(section)
        db.session.commit()

        return section

    except Exception as e:
        db.session.rollback()
        raise e
```

### **PASO 3: ACTUALIZACI√ìN SEGURA**

```python
def update_section_safely(section_id, new_variables, track_changes=True):
    """Actualizar secci√≥n existente de manera segura"""

    section = InvitationSectionsData.query.get(section_id)
    if not section:
        raise ValueError(f"Section {section_id} no existe")

    try:
        # Backup de datos anteriores
        old_variables = section.variables_json.copy()
        old_count = len(old_variables)
        new_count = len(new_variables)

        # Actualizar variables
        section.variables_json = new_variables

        # Actualizar usage_stats si se requiere tracking
        if track_changes and section.usage_stats:
            section.usage_stats['last_edited'] = datetime.now().isoformat()
            section.usage_stats['edit_count'] = section.usage_stats.get('edit_count', 0) + 1
            section.usage_stats['variables_change'] = {
                'old_count': old_count,
                'new_count': new_count,
                'delta': new_count - old_count
            }

        section.last_modified = datetime.now()
        db.session.commit()

        return section

    except Exception as e:
        db.session.rollback()
        raise e
```

---

## **‚ö†Ô∏è ERRORES COMUNES Y C√ìMO EVITARLOS**

### **1. ERRORES DE INTEGRIDAD REFERENCIAL**

```python
# ‚ùå ERROR COM√öN
section = InvitationSectionsData(
    invitation_id=999,  # No existe
    user_id=123,
    # ...
)

# ‚úÖ SOLUCI√ìN
invitation = Invitation.query.get(invitation_id)
if not invitation:
    raise ValueError(f"Invitation {invitation_id} no encontrada")

section = InvitationSectionsData(
    invitation_id=invitation.id,
    user_id=invitation.user_id,  # Consistencia garantizada
    # ...
)
```

### **2. DUPLICADOS DE SECCIONES**

```python
# ‚ùå ERROR COM√öN - No verificar existencia
section = InvitationSectionsData(
    invitation_id=1,
    section_type="hero",  # Ya existe
    # ...
)

# ‚úÖ SOLUCI√ìN - Verificar antes de crear
existing = InvitationSectionsData.query.filter_by(
    invitation_id=1,
    section_type="hero"
).first()

if existing:
    # Actualizar existente
    existing.variables_json = new_variables
else:
    # Crear nuevo
    section = InvitationSectionsData(...)
```

### **3. JSON MALFORMADO**

```python
# ‚ùå ERROR COM√öN
variables_json = '{"name": "Juan"}'  # String, no dict

# ‚úÖ SOLUCI√ìN
import json
variables_json = json.loads('{"name": "Juan"}')  # Dict
# O mejor a√∫n
variables_json = {"name": "Juan"}  # Dict directo
```

### **4. INCONSISTENCIAS EN NAMING**

```python
# ‚ùå INCONSISTENTE
variables = {
    "groom_name": "Juan",      # snake_case
    "brideName": "Mar√≠a",      # camelCase
    "wedding-date": "2025-01", # kebab-case
}

# ‚úÖ CONSISTENTE
variables = {
    "groom_name": "Juan",
    "bride_name": "Mar√≠a",
    "wedding_date": "2025-01-15T17:00:00"
}
```

---

## **üìä BUENAS PR√ÅCTICAS PARA ANALYTICS**

### **1. USAGE_STATS ESTRUCTURADO**

```python
# ‚úÖ ESTRUCTURA COMPLETA PARA ANALYTICS
usage_stats = {
    # Timestamps
    "created_at": "2025-01-24T10:30:00",
    "last_edited": "2025-01-24T15:45:00",

    # Contadores
    "edit_count": 5,
    "view_count": 23,
    "save_count": 5,

    # Metadata t√©cnica
    "source": "frontend_editor",
    "editor_version": "2.1.0",
    "api_version": "1.0",

    # Analytics de negocio
    "premium_features_used": ["custom_colors", "video_background"],
    "completion_percentage": 85,
    "complexity_score": 0.75,

    # Context de usuario
    "client_info": {
        "ip": "192.168.1.100",
        "country": "PE",
        "device": "desktop"
    }
}
```

### **2. QUERIES OPTIMIZADOS**

```sql
-- ‚úÖ Query eficiente para analytics
SELECT
    section_type,
    COUNT(*) as usage_count,
    AVG(variables_count) as avg_complexity,
    COUNT(DISTINCT user_id) as unique_users
FROM invitation_sections_data
WHERE category = 'weddings'
  AND created_at >= '2025-01-01'
GROUP BY section_type
ORDER BY usage_count DESC;

-- ‚úÖ Analytics por plan
SELECT
    p.name as plan_name,
    isd.section_type,
    AVG(isd.variables_count) as avg_variables,
    JSON_EXTRACT(isd.usage_stats, '$.premium_features_used') as premium_features
FROM invitation_sections_data isd
JOIN plans p ON isd.plan_id = p.id
WHERE isd.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY p.id, isd.section_type;
```

---

## **üîß HERRAMIENTAS Y SCRIPTS DE AYUDA**

### **1. SCRIPT DE VALIDACI√ìN**

```bash
# Validar integridad de datos
python scripts/validate_sections_data.py --check-all

# Validar secci√≥n espec√≠fica
python scripts/validate_sections_data.py --section-id 123

# Reparar inconsistencias
python scripts/validate_sections_data.py --repair --dry-run
```

### **2. COMANDOS SQL DE MANTENIMIENTO**

```sql
-- Verificar consistencia de datos
SELECT
    'Secciones sin invitation' as issue,
    COUNT(*) as count
FROM invitation_sections_data isd
LEFT JOIN invitations i ON isd.invitation_id = i.id
WHERE i.id IS NULL

UNION ALL

SELECT
    'Secciones sin usuario' as issue,
    COUNT(*)
FROM invitation_sections_data isd
LEFT JOIN users u ON isd.user_id = u.id
WHERE u.id IS NULL;

-- Limpiar secciones hu√©rfanas
DELETE isd FROM invitation_sections_data isd
LEFT JOIN invitations i ON isd.invitation_id = i.id
WHERE i.id IS NULL;
```

---

## **üìà M√âTRICAS Y MONITOREO**

### **ALERTAS AUTOM√ÅTICAS**

1. **Integridad:** Secciones hu√©rfanas > 0
2. **Performance:** Variables_count promedio > 50
3. **Errores:** Fallas de JSON parsing > 5%
4. **Negocio:** Secciones premium en planes b√°sicos

### **DASHBOARD RECOMENDADO**

```sql
-- M√©tricas clave para dashboard
CREATE VIEW sections_dashboard AS
SELECT
    DATE(created_at) as date,
    category,
    section_type,
    COUNT(*) as total_created,
    COUNT(DISTINCT user_id) as unique_users,
    AVG(variables_count) as avg_complexity,
    SUM(CASE WHEN plan_id > 1 THEN 1 ELSE 0 END) as premium_usage
FROM invitation_sections_data
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY DATE(created_at), category, section_type;
```

---

## **üéØ CHECKLIST FINAL**

Antes de registrar una nueva secci√≥n, verificar:

- [ ] **Invitation existe** y es accesible por el usuario
- [ ] **User_id coincide** con el owner de la invitaci√≥n
- [ ] **Plan_id es v√°lido** y est√° activo
- [ ] **Section_type** es v√°lido para la categor√≠a
- [ ] **Section_variant** sigue formato correcto
- [ ] **Variables_json** es v√°lido y bien estructurado
- [ ] **No existe duplicado** de la secci√≥n
- [ ] **Usage_stats** incluye metadata relevante
- [ ] **Transacci√≥n** maneja errores apropiadamente

---

**üìö DOCUMENTACI√ìN RELACIONADA:**
- `/docs/secciones/Secciones_wedding.md` - Variables wedding
- `/docs/secciones/Secciones_kids.md` - Variables kids
- `/docs/secciones/basededatos_secciones.md` - Arquitectura
- `/backend/models/invitation_sections_data.py` - Modelo SQLAlchemy

---

**‚ú® Esta gu√≠a garantiza la consistencia, integridad y performance del sistema de secciones para analytics avanzados** üöÄ