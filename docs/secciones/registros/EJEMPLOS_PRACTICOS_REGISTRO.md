# üéØ **EJEMPLOS PR√ÅCTICOS DE REGISTRO DE SECCIONES**

**Versi√≥n:** 1.0.0
**Fecha:** 24 de Enero, 2025
**Complemento:** BUENAS_PRACTICAS_REGISTRO_SECCIONES.md

---

## **üé™ CASOS DE USO REALES**

### **CASO 1: REGISTRO COMPLETO - WEDDING B√ÅSICO**

```python
def create_complete_wedding_basic():
    """
    Ejemplo completo de registro para boda - Plan B√°sico
    Incluye todas las validaciones y buenas pr√°cticas
    """

    # DATOS BASE
    invitation_id = 1
    user_id = 14
    order_id = 61
    plan_id = 1  # Plan B√°sico
    category = "weddings"

    # SECCIONES A CREAR
    sections_to_create = [
        {
            "section_type": "hero",
            "section_variant": "hero_2",
            "variables_json": {
                "groom_name": "Eduardo",
                "bride_name": "Mar√≠a",
                "weddingDate": "2025-08-15T17:00:00",
                "eventLocation": "Lima, Per√∫",
                "heroImageUrl": "https://cdn.example.com/hero-maria-eduardo.jpg",
                "navigationItems": [
                    {"href": "#inicio", "label": "Inicio"},
                    {"href": "#bienvenida", "label": "Bienvenida"},
                    {"href": "#ceremonia", "label": "Ceremonia"},
                    {"href": "#recepcion", "label": "Recepci√≥n"}
                ]
            }
        },
        {
            "section_type": "welcome",
            "section_variant": "welcome_2",
            "variables_json": {
                "welcome_title": "¬°Nos Casamos!",
                "welcome_description": "Con inmensa alegr√≠a queremos compartir con ustedes este momento tan especial de nuestras vidas. Despu√©s de 5 a√±os de amor y aventuras juntos, hemos decidido unir nuestras vidas para siempre."
            }
        },
        {
            "section_type": "countdown",
            "section_variant": "countdown_1",
            "variables_json": {
                "weddingDate": "2025-08-15T17:00:00",
                "countdown_backgroundImageUrl": "https://cdn.example.com/countdown-bg.jpg",
                "countdown_preTitle": "EL GRAN D√çA SE ACERCA",
                "countdown_title": "Faltan solo..."
            }
        }
    ]

    # CREAR CADA SECCI√ìN
    for section_data in sections_to_create:
        try:
            # Validar que no existe
            existing = InvitationSectionsData.query.filter_by(
                invitation_id=invitation_id,
                section_type=section_data["section_type"]
            ).first()

            if existing:
                print(f"‚ö†Ô∏è Secci√≥n {section_data['section_type']} ya existe - actualizando")
                existing.variables_json = section_data["variables_json"]
                existing.last_modified = datetime.now()
                continue

            # Crear usage_stats
            usage_stats = {
                "created_at": datetime.now().isoformat(),
                "source": "api_bulk_create",
                "plan_type": "basic",
                "initial_variables_count": len(section_data["variables_json"]),
                "category": category
            }

            # Crear secci√≥n
            section = InvitationSectionsData(
                invitation_id=invitation_id,
                user_id=user_id,
                order_id=order_id,
                plan_id=plan_id,
                section_type=section_data["section_type"],
                section_variant=section_data["section_variant"],
                category=category,
                variables_json=section_data["variables_json"],
                usage_stats=usage_stats
            )

            db.session.add(section)
            print(f"‚úÖ Secci√≥n {section_data['section_type']} creada")

        except Exception as e:
            print(f"‚ùå Error creando {section_data['section_type']}: {e}")
            db.session.rollback()
            continue

    db.session.commit()
    print("üéâ Registro completo finalizado")
```

### **CASO 2: WEDDING PREMIUM CON FEATURES AVANZADAS**

```python
def create_wedding_premium():
    """
    Ejemplo de registro para boda - Plan Premium
    Incluye features avanzadas y custom colors
    """

    # HERO SECTION CON FEATURES PREMIUM
    hero_premium = InvitationSectionsData(
        invitation_id=2,
        user_id=15,
        order_id=62,
        plan_id=2,  # Plan Premium
        section_type="hero",
        section_variant="hero_3",  # Variante premium
        category="weddings",
        variables_json={
            "groom_name": "Alejandro",
            "bride_name": "Sof√≠a",
            "weddingDate": "2025-09-20T18:00:00",
            "eventLocation": "Cusco, Per√∫",
            "heroImageUrl": "https://cdn.example.com/hero-sofia-alejandro.jpg",
            # FEATURES PREMIUM
            "custom_colors": {
                "primary": "#8B4513",      # Dorado terroso
                "secondary": "#F5DEB3",    # Trigo
                "accent": "#CD853F"        # Caf√© claro
            },
            "video_background": {
                "enabled": True,
                "video_url": "https://cdn.example.com/background-video.mp4",
                "fallback_image": "https://cdn.example.com/video-fallback.jpg"
            },
            "premium_typography": {
                "font_family": "Playfair Display",
                "font_weight": "400",
                "custom_css": ".hero-title { text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }"
            },
            "animated_elements": {
                "entrance_animation": "fadeInUp",
                "duration": 1200,
                "delay": 300
            }
        },
        usage_stats={
            "created_at": datetime.now().isoformat(),
            "source": "premium_designer",
            "plan_type": "premium",
            "premium_features_used": [
                "custom_colors",
                "video_background",
                "premium_typography",
                "animated_elements"
            ],
            "designer_id": 5,
            "design_session_duration": 45,  # minutos
            "revisions_count": 3
        }
    )

    db.session.add(hero_premium)
    db.session.commit()
```

### **CASO 3: KIDS BIRTHDAY PARTY**

```python
def create_kids_birthday():
    """
    Ejemplo de registro para cumplea√±os infantil
    Diferentes variables y estructura
    """

    party_sections = [
        {
            "section_type": "party_hero",
            "section_variant": "party_hero_1",
            "variables_json": {
                "childName": "Valentina",
                "age": 6,
                "birthdayDate": "2025-03-15",
                "partyTheme": "Unicornios y Arco√≠ris",
                "heroImageUrl": "https://cdn.example.com/valentina-unicorn.jpg",
                "backgroundColor": "#FFB6C1",  # Rosa claro
                "decorative_elements": [
                    {"type": "stars", "color": "#FFD700"},
                    {"type": "hearts", "color": "#FF69B4"},
                    {"type": "rainbows", "animation": "floating"}
                ]
            }
        },
        {
            "section_type": "party_games",
            "section_variant": "party_games_1",
            "variables_json": {
                "games_title": "¬°Diversi√≥n Asegurada!",
                "game1_name": "B√∫squeda del Tesoro de Unicornios",
                "game1_description": "Encuentra todos los cuernos dorados escondidos",
                "game1_duration": "20 minutos",
                "game2_name": "Pin the Horn on the Unicorn",
                "game2_description": "Versi√≥n m√°gica del juego cl√°sico",
                "game2_duration": "15 minutos",
                "game3_name": "Arco√≠ris Musical",
                "game3_description": "Baila cuando suene la m√∫sica m√°gica",
                "game3_duration": "25 minutos",
                "prize_info": "Todos los ni√±os recibir√°n un peque√±o unicornio de peluche"
            }
        },
        {
            "section_type": "party_info",
            "section_variant": "party_info_1",
            "variables_json": {
                "partyDate": "2025-03-15",
                "partyTime": "15:00",
                "partyEndTime": "18:00",
                "partyAddress": "Jr. Los Jardines 123, San Miguel, Lima",
                "partyVenue": "Sal√≥n de Fiestas Arco√≠ris",
                "contact_phone": "+51 999 123 456",
                "contact_whatsapp": "51999123456",
                "dress_code": "¬°Vengan vestidos de colores!",
                "bring_info": "Solo traigan muchas ganas de divertirse",
                "rsvp_info": "Confirmar asistencia hasta el 10 de marzo"
            }
        }
    ]

    for section_data in party_sections:
        section = InvitationSectionsData(
            invitation_id=3,
            user_id=16,
            order_id=None,  # Invitaci√≥n gratuita
            plan_id=1,      # Plan b√°sico
            section_type=section_data["section_type"],
            section_variant=section_data["section_variant"],
            category="kids",  # Categor√≠a diferente
            variables_json=section_data["variables_json"],
            usage_stats={
                "created_at": datetime.now().isoformat(),
                "source": "kids_template_wizard",
                "theme": "unicorns_rainbow",
                "age_group": "6-8",
                "party_size": "medium"  # 10-20 ni√±os
            }
        )

        db.session.add(section)

    db.session.commit()
```

---

## **üîÑ CASOS DE ACTUALIZACI√ìN**

### **ACTUALIZACI√ìN INCREMENTAL**

```python
def update_section_incrementally(section_id, field_updates):
    """
    Actualizar solo campos espec√≠ficos sin sobreescribir todo
    """

    section = InvitationSectionsData.query.get(section_id)
    if not section:
        raise ValueError(f"Section {section_id} no encontrada")

    # Backup de variables actuales
    current_variables = section.variables_json.copy()

    # Aplicar updates
    for field_name, new_value in field_updates.items():
        current_variables[field_name] = new_value

    # Actualizar con tracking
    section.variables_json = current_variables

    # Actualizar usage_stats
    if section.usage_stats:
        section.usage_stats['last_edited'] = datetime.now().isoformat()
        section.usage_stats['edit_count'] = section.usage_stats.get('edit_count', 0) + 1
        section.usage_stats['fields_updated'] = list(field_updates.keys())

    section.last_modified = datetime.now()
    db.session.commit()

    return section

# EJEMPLO DE USO
update_section_incrementally(1, {
    "bride_name": "Mar√≠a Elena",  # Cambio de nombre
    "heroImageUrl": "https://new-image.jpg"  # Nueva imagen
})
```

### **MIGRACI√ìN DE DATOS LEGACY**

```python
def migrate_from_invitation_data(invitation_id):
    """
    Migrar datos del sistema EAV legacy al nuevo sistema
    """

    # Obtener datos legacy
    legacy_data = db.session.query(InvitationData).filter_by(
        invitation_id=invitation_id
    ).all()

    # Agrupar por categor√≠a/secci√≥n
    sections_data = {}
    for item in legacy_data:
        section_type = determine_section_from_field(item.field_name)
        if section_type not in sections_data:
            sections_data[section_type] = {}

        # Convertir valor seg√∫n tipo
        sections_data[section_type][item.field_name] = convert_value(
            item.field_value, item.field_type
        )

    # Crear secciones en nuevo sistema
    invitation = Invitation.query.get(invitation_id)
    for section_type, variables in sections_data.items():
        section = InvitationSectionsData(
            invitation_id=invitation_id,
            user_id=invitation.user_id,
            order_id=invitation.order_id,
            plan_id=invitation.plan_id,
            section_type=section_type,
            section_variant=f"{section_type}_1",
            category="weddings",  # Asumir wedding por defecto
            variables_json=variables,
            usage_stats={
                "created_at": datetime.now().isoformat(),
                "source": "migration_from_eav",
                "legacy_field_count": len(variables),
                "migration_date": datetime.now().isoformat()
            }
        )

        db.session.add(section)

    db.session.commit()
    print(f"‚úÖ Migraci√≥n completada: {len(sections_data)} secciones creadas")
```

---

## **üìä CASOS DE ANALYTICS**

### **AN√ÅLISIS DE USO POR PLAN**

```python
def analyze_usage_by_plan():
    """
    Ejemplo de query para analytics de uso por plan
    """

    query = db.session.query(
        Plan.name.label('plan_name'),
        InvitationSectionsData.section_type,
        func.count(InvitationSectionsData.id).label('usage_count'),
        func.avg(InvitationSectionsData.variables_count).label('avg_complexity'),
        func.count(InvitationSectionsData.user_id.distinct()).label('unique_users')
    ).join(
        Plan, InvitationSectionsData.plan_id == Plan.id
    ).filter(
        InvitationSectionsData.created_at >= datetime.now() - timedelta(days=30)
    ).group_by(
        Plan.name, InvitationSectionsData.section_type
    ).order_by(
        'usage_count desc'
    ).all()

    # Procesar resultados
    analytics_data = {}
    for row in query:
        plan_name = row.plan_name
        if plan_name not in analytics_data:
            analytics_data[plan_name] = {}

        analytics_data[plan_name][row.section_type] = {
            'usage_count': row.usage_count,
            'avg_complexity': round(float(row.avg_complexity), 2),
            'unique_users': row.unique_users,
            'popularity_score': row.usage_count / row.unique_users
        }

    return analytics_data

# EJEMPLO DE RESULTADO
{
    "B√°sico": {
        "hero": {"usage_count": 45, "avg_complexity": 6.2, "unique_users": 40},
        "welcome": {"usage_count": 38, "avg_complexity": 2.1, "unique_users": 35}
    },
    "Premium": {
        "hero": {"usage_count": 23, "avg_complexity": 12.5, "unique_users": 20},
        "gallery": {"usage_count": 22, "avg_complexity": 8.9, "unique_users": 19}
    }
}
```

### **IDENTIFICAR CANDIDATOS A UPSELLING**

```python
def find_upselling_candidates():
    """
    Encontrar usuarios b√°sicos con alta complejidad
    Potenciales candidatos para upgrade a Premium
    """

    # Usuarios b√°sicos con muchas variables
    high_complexity_basic = db.session.query(
        InvitationSectionsData.user_id,
        func.avg(InvitationSectionsData.variables_count).label('avg_complexity'),
        func.count(InvitationSectionsData.id).label('sections_count'),
        User.email,
        User.first_name,
        User.last_name
    ).join(
        User, InvitationSectionsData.user_id == User.id
    ).filter(
        InvitationSectionsData.plan_id == 1  # Plan b√°sico
    ).group_by(
        InvitationSectionsData.user_id
    ).having(
        func.avg(InvitationSectionsData.variables_count) > 8  # Alta complejidad
    ).order_by(
        'avg_complexity desc'
    ).all()

    # Procesar para marketing
    candidates = []
    for user in high_complexity_basic:
        # Verificar si usa features que justifican premium
        premium_indicators = db.session.query(InvitationSectionsData).filter(
            InvitationSectionsData.user_id == user.user_id,
            InvitationSectionsData.variables_json.contains('"custom_colors"')
        ).count()

        candidates.append({
            'user_id': user.user_id,
            'email': user.email,
            'name': f"{user.first_name} {user.last_name}",
            'avg_complexity': round(float(user.avg_complexity), 2),
            'sections_count': user.sections_count,
            'premium_indicators': premium_indicators,
            'upselling_score': user.avg_complexity * user.sections_count + premium_indicators
        })

    return sorted(candidates, key=lambda x: x['upselling_score'], reverse=True)
```

---

## **üö® MANEJO DE ERRORES EN PRODUCCI√ìN**

### **VALIDACI√ìN ROBUSTA**

```python
class SectionValidationError(Exception):
    """Custom exception para errores de validaci√≥n de secciones"""
    pass

def create_section_with_full_validation(section_data):
    """
    Crear secci√≥n con validaci√≥n completa y manejo de errores
    """

    try:
        # 1. Validar estructura de datos
        required_fields = ['invitation_id', 'user_id', 'plan_id',
                          'section_type', 'section_variant', 'variables_json']

        for field in required_fields:
            if field not in section_data or section_data[field] is None:
                raise SectionValidationError(f"Campo requerido faltante: {field}")

        # 2. Validar tipos de datos
        if not isinstance(section_data['variables_json'], dict):
            raise SectionValidationError("variables_json debe ser un diccionario")

        if len(section_data['variables_json']) == 0:
            raise SectionValidationError("variables_json no puede estar vac√≠o")

        # 3. Validar integridad referencial
        invitation = Invitation.query.get(section_data['invitation_id'])
        if not invitation:
            raise SectionValidationError(f"Invitation {section_data['invitation_id']} no existe")

        if invitation.user_id != section_data['user_id']:
            raise SectionValidationError("user_id no coincide con owner de la invitaci√≥n")

        # 4. Validar l√≠mites de plan
        plan = Plan.query.get(section_data['plan_id'])
        if not plan:
            raise SectionValidationError(f"Plan {section_data['plan_id']} no existe")

        # Contar secciones existentes
        existing_sections = db.session.query(InvitationSectionsData).filter_by(
            invitation_id=section_data['invitation_id']
        ).count()

        max_sections = get_plan_limits(plan.id)['max_sections']
        if existing_sections >= max_sections:
            raise SectionValidationError(f"Plan {plan.name} permite m√°ximo {max_sections} secciones")

        # 5. Validar features premium
        if section_data['plan_id'] == 1:  # Plan b√°sico
            premium_features = detect_premium_features(section_data['variables_json'])
            if premium_features:
                raise SectionValidationError(f"Features premium detectadas en plan b√°sico: {premium_features}")

        # 6. Crear secci√≥n
        section = InvitationSectionsData(**section_data)
        db.session.add(section)
        db.session.commit()

        return section

    except SectionValidationError as e:
        db.session.rollback()
        log_validation_error(section_data, str(e))
        raise e

    except Exception as e:
        db.session.rollback()
        log_unexpected_error(section_data, str(e))
        raise SectionValidationError(f"Error inesperado: {str(e)}")

def detect_premium_features(variables_json):
    """Detectar si se est√°n usando features premium"""
    premium_indicators = []

    premium_fields = [
        'custom_colors', 'video_background', 'premium_typography',
        'animated_elements', 'advanced_gallery', 'custom_fonts'
    ]

    for field in premium_fields:
        if field in variables_json:
            premium_indicators.append(field)

    return premium_indicators

def get_plan_limits(plan_id):
    """Obtener l√≠mites del plan"""
    limits = {
        1: {'max_sections': 8, 'max_variables_per_section': 15},   # B√°sico
        2: {'max_sections': 20, 'max_variables_per_section': 50},  # Premium
        3: {'max_sections': -1, 'max_variables_per_section': -1}   # Enterprise (sin l√≠mite)
    }
    return limits.get(plan_id, limits[1])
```

---

## **üìã CHECKLIST DE TESTING**

### **TESTS UNITARIOS**

```python
import pytest
from datetime import datetime

class TestSectionRegistration:

    def test_create_valid_section(self):
        """Test creaci√≥n b√°sica v√°lida"""
        section_data = {
            'invitation_id': 1,
            'user_id': 14,
            'plan_id': 1,
            'section_type': 'hero',
            'section_variant': 'hero_1',
            'category': 'weddings',
            'variables_json': {'groom_name': 'Test', 'bride_name': 'Test'}
        }

        section = create_section_with_full_validation(section_data)
        assert section.id is not None
        assert section.variables_count == 2

    def test_invalid_json_variables(self):
        """Test variables_json inv√°lido"""
        section_data = {
            'invitation_id': 1,
            'user_id': 14,
            'plan_id': 1,
            'section_type': 'hero',
            'section_variant': 'hero_1',
            'variables_json': "invalid json string"  # String en lugar de dict
        }

        with pytest.raises(SectionValidationError):
            create_section_with_full_validation(section_data)

    def test_premium_features_in_basic_plan(self):
        """Test features premium en plan b√°sico"""
        section_data = {
            'invitation_id': 1,
            'user_id': 14,
            'plan_id': 1,  # Plan b√°sico
            'section_type': 'hero',
            'section_variant': 'hero_1',
            'variables_json': {
                'groom_name': 'Test',
                'custom_colors': {'primary': '#123456'}  # Feature premium
            }
        }

        with pytest.raises(SectionValidationError, match="Features premium detectadas"):
            create_section_with_full_validation(section_data)

    def test_section_limits_by_plan(self):
        """Test l√≠mites de secciones por plan"""
        # Crear 8 secciones (l√≠mite b√°sico)
        for i in range(8):
            section_data = {
                'invitation_id': 1,
                'user_id': 14,
                'plan_id': 1,
                'section_type': f'test_section_{i}',
                'section_variant': f'test_section_{i}_1',
                'variables_json': {'test': 'data'}
            }
            create_section_with_full_validation(section_data)

        # Intentar crear la 9na (debe fallar)
        with pytest.raises(SectionValidationError, match="permite m√°ximo"):
            section_data['section_type'] = 'test_section_9'
            create_section_with_full_validation(section_data)
```

---

## **üì¶ CASO 9: ESTRUCTURA DEL LOCALSTORAGE Y TRANSFORMACI√ìN**

### **CONTEXTO**
El frontend almacena los datos de personalizaci√≥n en localStorage como un objeto plano. Para enviarlos al backend, necesitan ser agrupados por secciones.

### **ESTRUCTURA ACTUAL EN LOCALSTORAGE**

```json
{
  "customizerData": {
    // TODOS los campos en un objeto plano (sin agrupaci√≥n)
    "groom_name": "Jefferson",
    "bride_name": "Rosmery",
    "weddingDate": "2024-12-15T17:00:00",
    "eventLocation": "Lima, Per√∫",
    "heroImageUrl": "https://cdn.example.com/hero-image.jpg",

    // Campos con prefijos que indican su secci√≥n
    "familiares_padre_novio": "Juan P√©rez",
    "familiares_madre_novio": "Mar√≠a Garc√≠a",
    "familiares_padre_novia": "Carlos L√≥pez",
    "familiares_madre_novia": "Ana Mart√≠nez",

    "welcome_title": "¬°Nos Casamos!",
    "welcome_description": "Con alegr√≠a queremos compartir este momento...",
    "welcome_couplePhotoUrl": "https://cdn.example.com/couple.jpg",

    "place_religioso_titulo": "Ceremonia Religiosa",
    "place_religioso_lugar": "Iglesia San Pedro",
    "place_religioso_direccion": "Av. Principal 123, Lima",

    "gallery_images": [
      {"url": "https://cdn.example.com/img1.jpg", "alt": "Foto 1"},
      {"url": "https://cdn.example.com/img2.jpg", "alt": "Foto 2"}
    ],

    "countdown_title": "Cuenta Regresiva",
    "story_moment_1_title": "Nos Conocimos",
    "itinerary_event_ceremonia_time": "16:00"
  },

  "touchedFields": {
    // Campos que el usuario ha modificado
    "groom_name": true,
    "bride_name": true,
    "familiares_padre_novio": true,
    "welcome_title": true
  },

  "selectedMode": "basic",  // NUEVO: "basic" o "full" - determina el plan_id

  "timestamp": 1706234567890  // Unix timestamp
}
```

### **PROCESO DE TRANSFORMACI√ìN**

```javascript
// frontend/src/lib/utils/localStorage-to-sections.ts

function groupCustomizerDataBySections(customizerData) {
  const sections = {};

  Object.entries(customizerData).forEach(([key, value]) => {
    let sectionName = null;

    // 1. Detectar secci√≥n por prefijo
    if (key.startsWith('familiares_')) {
      sectionName = 'familiares';
    } else if (key.startsWith('welcome_')) {
      sectionName = 'welcome';
    } else if (key.startsWith('place_religioso_')) {
      sectionName = 'place_religioso';
    } else if (key.startsWith('place_ceremonia_')) {
      sectionName = 'place_ceremonia';
    } else if (key.startsWith('gallery_')) {
      sectionName = 'gallery';
    }
    // ... m√°s prefijos

    // 2. Campos sin prefijo van a 'hero' por defecto
    else if (['groom_name', 'bride_name', 'weddingDate',
              'eventLocation', 'heroImageUrl'].includes(key)) {
      sectionName = 'hero';
    }

    // 3. Agrupar por secci√≥n
    if (sectionName) {
      if (!sections[sectionName]) {
        sections[sectionName] = {};
      }
      sections[sectionName][key] = value;
    }
  });

  return sections;
}
```

### **ESTRUCTURA TRANSFORMADA PARA EL BACKEND**

```json
{
  "user_data": {
    "email": "usuario@example.com",
    "first_name": "Jefferson",
    "last_name": "Smith",
    "phone": "+51999999999"
  },

  "invitation_basic": {
    "template_id": 1,
    "plan_id": 1,
    "event_date": "2024-12-15T17:00:00",
    "event_location": "Lima, Per√∫"
  },

  "sections_data": {
    "hero": {
      "groom_name": "Jefferson",
      "bride_name": "Rosmery",
      "weddingDate": "2024-12-15T17:00:00",
      "eventLocation": "Lima, Per√∫",
      "heroImageUrl": "https://cdn.example.com/hero-image.jpg"
    },

    "familiares": {
      "familiares_padre_novio": "Juan P√©rez",
      "familiares_madre_novio": "Mar√≠a Garc√≠a",
      "familiares_padre_novia": "Carlos L√≥pez",
      "familiares_madre_novia": "Ana Mart√≠nez"
    },

    "welcome": {
      "welcome_title": "¬°Nos Casamos!",
      "welcome_description": "Con alegr√≠a queremos compartir este momento...",
      "welcome_couplePhotoUrl": "https://cdn.example.com/couple.jpg"
    },

    "place_religioso": {
      "place_religioso_titulo": "Ceremonia Religiosa",
      "place_religioso_lugar": "Iglesia San Pedro",
      "place_religioso_direccion": "Av. Principal 123, Lima"
    },

    "gallery": {
      "gallery_images": [
        {"url": "https://cdn.example.com/img1.jpg", "alt": "Foto 1"},
        {"url": "https://cdn.example.com/img2.jpg", "alt": "Foto 2"}
      ]
    }
  }
}
```

### **OBTENCI√ìN DE DATOS DEL USUARIO LOGEADO**

El sistema de autenticaci√≥n guarda los datos del usuario en localStorage y Zustand store despu√©s del login.

#### **Datos Disponibles del Usuario Autenticado**

```javascript
// localStorage keys despu√©s del login
localStorage.getItem('auth_token')     // JWT access token
localStorage.getItem('refresh_token')  // JWT refresh token
localStorage.getItem('user_data')      // Datos completos del usuario (JSON)

// Estructura de user_data
{
  "id": 123,
  "email": "usuario@example.com",
  "first_name": "Juan",
  "last_name": "P√©rez",
  "phone": "+51999999999",
  "role": "CLIENT",
  "is_active": true,
  "email_verified": true,
  "google_id": "1234567890",      // Si es login con Google
  "provider": "google",            // O null si es login normal
  "profile_picture": "https://..." // URL de foto de perfil
}
```

#### **Mapeo de Datos del Usuario al Endpoint**

| Campo Auth Store | Campo Endpoint | Requerido | Ejemplo |
|-----------------|----------------|-----------|---------|
| `user.email` | `user_data.email` | ‚úÖ S√≠ | `"usuario@example.com"` |
| `user.first_name` | `user_data.first_name` | ‚úÖ S√≠ | `"Juan"` |
| `user.last_name` | `user_data.last_name` | ‚ö™ Opcional | `"P√©rez"` |
| `user.phone` | `user_data.phone` | ‚ö™ Opcional | `"+51999999999"` |

#### **Mapeo de Modo de Personalizaci√≥n a Plan ID**

| Modo en Customizer | Plan ID en Backend | Descripci√≥n |
|-------------------|-------------------|-------------|
| `"basic"` | `1` | Plan B√°sico - Campos limitados |
| `"full"` | `2` | Plan Completo/Premium - Todos los campos |
| `undefined` | `1` | Default a Plan B√°sico |

### **IMPLEMENTACI√ìN COMPLETA CON USUARIO AUTENTICADO**

```javascript
// frontend/src/lib/api/invitation-create.ts

import { prepareInvitationCreateRequest } from '../utils/localStorage-to-sections';
import { useUser } from '@/store/authStore';

// OPCI√ìN 1: Usando Zustand Store (Recomendado)
async function saveInvitationFromAuthenticatedUser(templateId, planId) {
  // Obtener usuario desde el store
  const user = useUser();

  if (!user) {
    throw new Error('Usuario no autenticado');
  }

  try {
    // 1. Preparar request con datos del usuario autenticado
    const requestData = prepareInvitationCreateRequest(
      templateId,
      {
        email: user.email,
        firstName: user.first_name,
        lastName: user.last_name,
        phone: user.phone
      },
      planId
    );

    // 2. Enviar al backend
    const response = await fetch('/api/invitations/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestData)
    });

    if (!response.ok) {
      throw new Error('Error al crear invitaci√≥n');
    }

    const data = await response.json();

    // 3. Redirigir a la URL de la invitaci√≥n
    window.location.href = data.invitation.url;

    return data;

  } catch (error) {
    console.error('Error:', error);
    throw error;
  }
}

// OPCI√ìN 2: Obteniendo datos directamente de localStorage
async function saveInvitationFromLocalStorage(templateId, planId) {
  // Obtener datos del usuario desde localStorage
  const userDataString = localStorage.getItem('user_data');

  if (!userDataString) {
    throw new Error('No hay datos de usuario en localStorage');
  }

  const userData = JSON.parse(userDataString);

  try {
    // 1. Obtener datos del customizer
    const customizerData = getCustomizerDataFromLocalStorage(templateId);

    if (!customizerData) {
      throw new Error('No hay datos de personalizaci√≥n');
    }

    // 2. Agrupar por secciones
    const sectionsData = groupCustomizerDataBySections(customizerData.customizerData);

    // 3. Construir request completo
    const requestData = {
      user_data: {
        email: userData.email,
        first_name: userData.first_name,
        last_name: userData.last_name || '',
        phone: userData.phone || ''
      },
      invitation_basic: {
        template_id: templateId,
        plan_id: planId,
        event_date: customizerData.customizerData.weddingDate || new Date().toISOString(),
        event_location: customizerData.customizerData.eventLocation || 'Por definir'
      },
      sections_data: sectionsData
    };

    // 4. Enviar al backend
    const response = await fetch('/api/invitations/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestData)
    });

    if (!response.ok) {
      throw new Error('Error al crear invitaci√≥n');
    }

    return await response.json();

  } catch (error) {
    console.error('Error:', error);
    throw error;
  }
}
```

### **VALIDACIONES ANTES DE ENVIAR**

```javascript
function validateCustomizerData(templateId) {
  const errors = [];
  const warnings = [];

  const data = getCustomizerDataFromLocalStorage(templateId);

  if (!data) {
    errors.push('No hay datos en localStorage');
    return { isValid: false, errors };
  }

  const { customizerData, touchedFields } = data;

  // Validar campos m√≠nimos
  if (!customizerData.groom_name && !customizerData.bride_name) {
    warnings.push('Faltan nombres de los novios');
  }

  if (Object.keys(touchedFields).length === 0) {
    warnings.push('No se ha personalizado ning√∫n campo');
  }

  // Verificar agrupaci√≥n
  const sections = groupCustomizerDataBySections(customizerData);
  if (Object.keys(sections).length === 0) {
    errors.push('No se pueden agrupar los campos');
  }

  return {
    isValid: errors.length === 0,
    errors,
    warnings
  };
}
```

### **MAPEO DE PREFIJOS A SECCIONES**

| Prefijo | Secci√≥n | Ejemplo de Campo |
|---------|---------|------------------|
| Sin prefijo | `hero` | `groom_name`, `bride_name`, `weddingDate` |
| `familiares_` | `familiares` | `familiares_padre_novio` |
| `welcome_` | `welcome` | `welcome_title` |
| `place_religioso_` | `place_religioso` | `place_religioso_lugar` |
| `place_ceremonia_` | `place_ceremonia` | `place_ceremonia_hora` |
| `vestimenta_` | `vestimenta` | `vestimenta_etiqueta` |
| `countdown_` | `countdown` | `countdown_title` |
| `gallery_` | `gallery` | `gallery_images` |
| `story_` | `story` | `story_moment_1_title` |
| `itinerary_` | `itinerary` | `itinerary_event_ceremonia_time` |
| `couple_` | `couple` | `couple_sectionTitle` |
| `video_` | `video` | `video_videoEmbedUrl` |
| `footer_` | `footer` | `footer_copyrightText` |

### **EJEMPLO DE USO SIMPLIFICADO (RECOMENDADO)**

```javascript
// frontend/src/lib/api/invitation-create.ts

import { createInvitationFromAuth } from '@/lib/api/invitation-create';

// Funci√≥n simplificada para usuarios autenticados
async function guardarInvitacion(templateId, planId = 1) {
  try {
    // Todo autom√°tico: obtiene user_data, customizer_data, agrupa por secciones
    const result = await createInvitationFromAuth(templateId, planId);

    // Redirigir autom√°ticamente a la invitaci√≥n creada
    window.location.href = result.invitation.url;

    return result;

  } catch (error) {
    console.error('Error al guardar:', error.message);
    // Mostrar error al usuario
    alert(`Error: ${error.message}`);
  }
}

// Uso en componente React
function SaveButton({ templateId }) {
  const handleSave = () => {
    guardarInvitacion(templateId, 1); // Plan b√°sico
  };

  return (
    <button onClick={handleSave}>
      Guardar Invitaci√≥n
    </button>
  );
}
```

### **VENTAJAS DEL ENFOQUE INTEGRADO**

1. **‚úÖ Autom√°tico**: No necesitas pasar datos del usuario manualmente
2. **‚úÖ Seguro**: Usa datos verificados del sistema de auth
3. **‚úÖ Simple**: Solo requiere `templateId` y `planId`
4. **‚úÖ Completo**: Incluye customizer + user_data + secciones agrupadas
5. **‚úÖ Error Handling**: Manejo completo de errores de auth y API

### **NOTAS IMPORTANTES**

1. **NO se requiere cambiar nombres de variables** - El backend acepta cualquier estructura JSON en `variables_json`
2. **Los prefijos se mantienen** - No es necesario removerlos al agrupar
3. **Flexibilidad total** - El backend no valida nombres espec√≠ficos de campos
4. **localStorage es plano** - Siempre requiere transformaci√≥n antes de enviar
5. **touchedFields** indica qu√© campos fueron modificados por el usuario
6. **Datos del usuario autom√°ticos** - Se obtienen del auth store sin intervenci√≥n manual

---

## **üì¶ CASO 10: CREACI√ìN DESDE CHECKOUT POST-PAGO**

### **CONTEXTO**
Cuando un usuario completa el pago exitosamente en el checkout, se debe crear autom√°ticamente la invitaci√≥n con todos los datos personalizados que guard√≥ en localStorage durante la personalizaci√≥n. Este flujo garantiza que el pago se procese primero y luego se cree la invitaci√≥n con la configuraci√≥n guardada.

### **FLUJO COMPLETO DETALLADO**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PASO 1: PERSONALIZACI√ìN (Frontend)                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1.1 Usuario accede a /invitacion/demo/{template_id}                ‚îÇ
‚îÇ 1.2 DynamicCustomizer carga datos del template desde API           ‚îÇ
‚îÇ 1.3 Usuario modifica campos (nombres, fotos, textos)               ‚îÇ
‚îÇ 1.4 useCustomizerSync guarda cambios en localStorage:              ‚îÇ
‚îÇ     - Key: "customizerData"                                         ‚îÇ
‚îÇ     - Formato: Objeto plano con todos los campos                   ‚îÇ
‚îÇ     - Ejemplo: {hero_groom_name: "Jeff", welcome_title: "..."}     ‚îÇ
‚îÇ 1.5 FileImagePicker convierte im√°genes a base64                    ‚îÇ
‚îÇ 1.6 MultiImageGalleryPicker convierte galer√≠a a base64             ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ Estado localStorage al finalizar:                                   ‚îÇ
‚îÇ {                                                                   ‚îÇ
‚îÇ   "customizerData": {                                               ‚îÇ
‚îÇ     "template_id": 7,                                               ‚îÇ
‚îÇ     "plan_id": 1,                                                   ‚îÇ
‚îÇ     "hero_groom_name": "Jefferson",                                 ‚îÇ
‚îÇ     "hero_bride_name": "Rosmery",                                   ‚îÇ
‚îÇ     "hero_imageUrl": "data:image/png;base64,...",                   ‚îÇ
‚îÇ     "welcome_title": "¬°Nos Casamos!",                               ‚îÇ
‚îÇ     "gallery_images": [{url: "data:image/...", alt: "Foto 1"}],    ‚îÇ
‚îÇ     ...                                                             ‚îÇ
‚îÇ   },                                                                ‚îÇ
‚îÇ   "touchedFields": {                                                ‚îÇ
‚îÇ     "hero_groom_name": true,                                        ‚îÇ
‚îÇ     "hero_bride_name": true                                         ‚îÇ
‚îÇ   }                                                                 ‚îÇ
‚îÇ }                                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PASO 2: AGREGAR AL CARRITO (Frontend)                              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 2.1 Usuario hace clic en "Agregar al Carrito"                      ‚îÇ
‚îÇ 2.2 Sistema llama POST /api/cart/add con:                          ‚îÇ
‚îÇ     - template_id                                                   ‚îÇ
‚îÇ     - quantity: 1                                                   ‚îÇ
‚îÇ     - price (del template)                                          ‚îÇ
‚îÇ 2.3 Backend crea CartItem en base de datos                         ‚îÇ
‚îÇ 2.4 localStorage mantiene customizerData (NO se env√≠a al carrito)  ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ IMPORTANTE: Los datos de personalizaci√≥n NO van al carrito,        ‚îÇ
‚îÇ solo se mantienen en localStorage hasta el pago.                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PASO 3: CHECKOUT - CREAR ORDEN (Frontend + Backend)                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 3.1 Usuario completa formulario de checkout                        ‚îÇ
‚îÇ     - Datos personales (nombre, email, tel√©fono)                   ‚îÇ
‚îÇ     - Direcci√≥n de facturaci√≥n                                     ‚îÇ
‚îÇ     - Tipo y n√∫mero de documento                                   ‚îÇ
‚îÇ     - Acepta t√©rminos y condiciones                                ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 3.2 Sistema valida formulario con Zod schema                       ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 3.3 Frontend llama POST /api/orders/create con:                    ‚îÇ
‚îÇ     {                                                               ‚îÇ
‚îÇ       "billing_address": {                                          ‚îÇ
‚îÇ         "first_name": "Jefferson",                                  ‚îÇ
‚îÇ         "last_name": "Smith",                                       ‚îÇ
‚îÇ         "email": "jeff@example.com",                                ‚îÇ
‚îÇ         "phone": "+51999999999",                                    ‚îÇ
‚îÇ         "address": "Av. Lima 123",                                  ‚îÇ
‚îÇ         "city": "Lima",                                             ‚îÇ
‚îÇ         "state": "Lima",                                            ‚îÇ
‚îÇ         "zip_code": "15001",                                        ‚îÇ
‚îÇ         "country": "PE",                                            ‚îÇ
‚îÇ         "document_type": "dni",                                     ‚îÇ
‚îÇ         "document_number": "12345678"                               ‚îÇ
‚îÇ       },                                                            ‚îÇ
‚îÇ       "coupon_code": "PROMO20" // Si aplica                         ‚îÇ
‚îÇ     }                                                               ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 3.4 Backend (orders.py) ejecuta:                                   ‚îÇ
‚îÇ     - Valida cart no est√© vac√≠o                                    ‚îÇ
‚îÇ     - Valida coupon si existe                                      ‚îÇ
‚îÇ     - Genera order_number √∫nico (ORD-20250130-XXXX)                ‚îÇ
‚îÇ     - Crea registro en tabla Order con status='PENDING'            ‚îÇ
‚îÇ     - Calcula total con descuento si aplica                        ‚îÇ
‚îÇ     - Guarda billing_address_json                                  ‚îÇ
‚îÇ     - Retorna order con todos sus datos                            ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 3.5 Frontend recibe:                                               ‚îÇ
‚îÇ     {                                                               ‚îÇ
‚îÇ       "success": true,                                              ‚îÇ
‚îÇ       "order": {                                                    ‚îÇ
‚îÇ         "id": 123,                                                  ‚îÇ
‚îÇ         "order_number": "ORD-20250130-ABC123",                      ‚îÇ
‚îÇ         "status": "PENDING",                                        ‚îÇ
‚îÇ         "total": 290.00,                                            ‚îÇ
‚îÇ         "currency": "PEN",                                          ‚îÇ
‚îÇ         "items": [...]                                              ‚îÇ
‚îÇ       }                                                             ‚îÇ
‚îÇ     }                                                               ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 3.6 Frontend guarda order en estado local: setCurrentOrder(order)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PASO 4: CREAR TOKEN DE PAGO (Frontend + Backend)                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 4.1 Frontend llama POST /api/payments/create-token con:            ‚îÇ
‚îÇ     {                                                               ‚îÇ
‚îÇ       "order_id": 123,                                              ‚îÇ
‚îÇ       "billing_info": {                                             ‚îÇ
‚îÇ         "firstName": "Jefferson",                                   ‚îÇ
‚îÇ         "lastName": "Smith",                                        ‚îÇ
‚îÇ         "email": "jeff@example.com",                                ‚îÇ
‚îÇ         "phoneNumber": "+51999999999",                              ‚îÇ
‚îÇ         "street": "Av. Lima 123",                                   ‚îÇ
‚îÇ         "city": "Lima",                                             ‚îÇ
‚îÇ         "state": "Lima",                                            ‚îÇ
‚îÇ         "country": "PE",                                            ‚îÇ
‚îÇ         "postalCode": "15001",                                      ‚îÇ
‚îÇ         "document": "12345678",                                     ‚îÇ
‚îÇ         "documentType": "DNI"                                       ‚îÇ
‚îÇ       }                                                             ‚îÇ
‚îÇ     }                                                               ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 4.2 Backend (payments.py) ejecuta:                                 ‚îÇ
‚îÇ     - Valida que Order existe y est√° PENDING                       ‚îÇ
‚îÇ     - Crea payload para Izipay API                                 ‚îÇ
‚îÇ     - Llama a Izipay: POST /api-payment/V4/Charge/CreatePayment    ‚îÇ
‚îÇ     - Recibe formToken de Izipay                                   ‚îÇ
‚îÇ     - Retorna formToken y publicKey al frontend                    ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 4.3 Frontend recibe:                                               ‚îÇ
‚îÇ     {                                                               ‚îÇ
‚îÇ       "success": true,                                              ‚îÇ
‚îÇ       "formToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",       ‚îÇ
‚îÇ       "publicKey": "12345678:testpublickey_XXXX"                    ‚îÇ
‚îÇ     }                                                               ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 4.4 Frontend cambia a paso 2 del checkout: setCurrentStep(2)       ‚îÇ
‚îÇ 4.5 Frontend renderiza componente IzipayCheckout                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PASO 5: PROCESAMIENTO DE PAGO (Izipay + Backend)                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 5.1 IzipayCheckout inicializa formulario de pago con:              ‚îÇ
‚îÇ     - formToken recibido                                            ‚îÇ
‚îÇ     - publicKey de Izipay                                           ‚îÇ
‚îÇ     - Biblioteca @lyracom/embedded-form-glue                        ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 5.2 Usuario ingresa datos de tarjeta en iframe de Izipay           ‚îÇ
‚îÇ     - N√∫mero de tarjeta                                             ‚îÇ
‚îÇ     - Fecha de expiraci√≥n                                           ‚îÇ
‚îÇ     - CVV                                                           ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 5.3 Izipay procesa el pago de manera segura (PCI compliant)        ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 5.4 Izipay retorna resultado al frontend v√≠a callback               ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 5.5 Si EXITOSO: onPaymentComplete se ejecuta con paymentResult     ‚îÇ
‚îÇ 5.6 Si ERROR: onPaymentError se ejecuta con error details          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PASO 6: CONFIRMAR PAGO (Frontend + Backend)                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 6.1 Frontend ejecuta handlePaymentSuccess()                        ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 6.2 Frontend llama POST /api/payments/process con:                 ‚îÇ
‚îÇ     {                                                               ‚îÇ
‚îÇ       "order_id": 123,                                              ‚îÇ
‚îÇ       "payment_result": {                                           ‚îÇ
‚îÇ         "status": "SUCCESS",                                        ‚îÇ
‚îÇ         "transaction_id": "ORD-20250130-ABC123",                    ‚îÇ
‚îÇ         "izipay_data": {                                            ‚îÇ
‚îÇ           "orderStatus": "PAID",                                    ‚îÇ
‚îÇ           "orderDetails": {...}                                     ‚îÇ
‚îÇ         }                                                           ‚îÇ
‚îÇ       }                                                             ‚îÇ
‚îÇ     }                                                               ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 6.3 Backend (payments.py) ejecuta:                                 ‚îÇ
‚îÇ     - Valida que Order existe                                      ‚îÇ
‚îÇ     - Actualiza Order.status = 'PAID'                              ‚îÇ
‚îÇ     - Guarda payment_details_json con datos de Izipay              ‚îÇ
‚îÇ     - Actualiza paid_at timestamp                                  ‚îÇ
‚îÇ     - Limpia CartItems asociados al usuario                        ‚îÇ
‚îÇ     - Commit a base de datos                                       ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 6.4 Backend retorna:                                               ‚îÇ
‚îÇ     {                                                               ‚îÇ
‚îÇ       "success": true,                                              ‚îÇ
‚îÇ       "message": "Payment processed successfully",                  ‚îÇ
‚îÇ       "order": {                                                    ‚îÇ
‚îÇ         "id": 123,                                                  ‚îÇ
‚îÇ         "status": "PAID",                                           ‚îÇ
‚îÇ         ...                                                         ‚îÇ
‚îÇ       }                                                             ‚îÇ
‚îÇ     }                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PASO 7: CREAR INVITACI√ìN (Frontend + Backend) ‚Üê NUEVO              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 7.1 Frontend (MISMO handlePaymentSuccess) ejecuta:                 ‚îÇ
‚îÇ     - Lee localStorage.getItem('customizerData')                   ‚îÇ
‚îÇ     - Parse JSON de los datos                                      ‚îÇ
‚îÇ     - Extrae template_id del customizerData                        ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 7.2 Validaci√≥n de datos:                                           ‚îÇ
‚îÇ     if (templateId && Object.keys(customizerData).length > 0) {    ‚îÇ
‚îÇ       // Continuar con creaci√≥n                                    ‚îÇ
‚îÇ     } else {                                                        ‚îÇ
‚îÇ       // Redirigir a orden sin crear invitaci√≥n                    ‚îÇ
‚îÇ     }                                                               ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 7.3 Frontend llama extractInvitationMetadata(customizerData):      ‚îÇ
‚îÇ     - Extrae: event_date, title, groom_name, bride_name            ‚îÇ
‚îÇ     - Busca en m√∫ltiples campos posibles:                          ‚îÇ
‚îÇ       * hero_date, countdown_date ‚Üí event_date                     ‚îÇ
‚îÇ       * hero_title ‚Üí title                                         ‚îÇ
‚îÇ       * hero_groom_name, couple_groom_name ‚Üí groom_name            ‚îÇ
‚îÇ       * hero_bride_name, couple_bride_name ‚Üí bride_name            ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 7.4 Frontend llama createInvitationFromOrder():                    ‚îÇ
‚îÇ     - Par√°metros:                                                   ‚îÇ
‚îÇ       * orderId: currentOrder.id (123)                             ‚îÇ
‚îÇ       * templateId: extra√≠do de customizerData                     ‚îÇ
‚îÇ       * customizerData: objeto completo de localStorage            ‚îÇ
‚îÇ       * metadata: {event_date, title, groom_name, bride_name}      ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 7.5 createInvitationFromOrder() procesa:                           ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ     A) Agrupa datos por secciones con groupCustomizerDataBySections‚îÇ
‚îÇ        Input (plano):                                               ‚îÇ
‚îÇ        {                                                            ‚îÇ
‚îÇ          "hero_groom_name": "Jefferson",                            ‚îÇ
‚îÇ          "hero_bride_name": "Rosmery",                              ‚îÇ
‚îÇ          "hero_imageUrl": "data:image/...",                         ‚îÇ
‚îÇ          "welcome_title": "¬°Nos Casamos!",                          ‚îÇ
‚îÇ          "welcome_description": "Con alegr√≠a...",                   ‚îÇ
‚îÇ          "gallery_images": [...]                                    ‚îÇ
‚îÇ        }                                                            ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ        Output (agrupado):                                           ‚îÇ
‚îÇ        {                                                            ‚îÇ
‚îÇ          "hero": {                                                  ‚îÇ
‚îÇ            "hero_groom_name": "Jefferson",                          ‚îÇ
‚îÇ            "hero_bride_name": "Rosmery",                            ‚îÇ
‚îÇ            "hero_imageUrl": "data:image/..."                        ‚îÇ
‚îÇ          },                                                         ‚îÇ
‚îÇ          "welcome": {                                               ‚îÇ
‚îÇ            "welcome_title": "¬°Nos Casamos!",                        ‚îÇ
‚îÇ            "welcome_description": "Con alegr√≠a..."                  ‚îÇ
‚îÇ          },                                                         ‚îÇ
‚îÇ          "gallery": {                                               ‚îÇ
‚îÇ            "gallery_images": [...]                                  ‚îÇ
‚îÇ          }                                                          ‚îÇ
‚îÇ        }                                                            ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ        L√≥gica de agrupaci√≥n:                                        ‚îÇ
‚îÇ        - Si key.startsWith("hero_") ‚Üí Secci√≥n "hero"               ‚îÇ
‚îÇ        - Si key.startsWith("welcome_") ‚Üí Secci√≥n "welcome"         ‚îÇ
‚îÇ        - Si key.startsWith("gallery_") ‚Üí Secci√≥n "gallery"         ‚îÇ
‚îÇ        - Variables sin prefijo ‚Üí Secci√≥n "general"                 ‚îÇ
‚îÇ        - Mantiene nombres originales (NO los renombra)             ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ     B) Determina plan_id:                                           ‚îÇ
‚îÇ        Priority order:                                              ‚îÇ
‚îÇ        1. customizerData.template?.plan_id                          ‚îÇ
‚îÇ        2. customizerData.plan_id                                    ‚îÇ
‚îÇ        3. Default: 1 (Plan B√°sico)                                 ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ     C) Construye payload:                                           ‚îÇ
‚îÇ        {                                                            ‚îÇ
‚îÇ          "order_id": 123,                                           ‚îÇ
‚îÇ          "template_id": 7,                                          ‚îÇ
‚îÇ          "plan_id": 1,                                              ‚îÇ
‚îÇ          "sections_data": {                                         ‚îÇ
‚îÇ            "hero": {...},                                           ‚îÇ
‚îÇ            "welcome": {...},                                        ‚îÇ
‚îÇ            "gallery": {...}                                         ‚îÇ
‚îÇ          },                                                         ‚îÇ
‚îÇ          "event_date": "2024-12-15T17:00:00",                       ‚îÇ
‚îÇ          "title": "Boda Jefferson & Rosmery",                       ‚îÇ
‚îÇ          "groom_name": "Jefferson",                                 ‚îÇ
‚îÇ          "bride_name": "Rosmery"                                    ‚îÇ
‚îÇ        }                                                            ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 7.6 Frontend llama POST /api/invitations/create-from-order         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PASO 8: BACKEND CREA INVITACI√ìN                                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 8.1 Backend (invitations.py) recibe request                        ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 8.2 Validaciones de seguridad:                                     ‚îÇ
‚îÇ     - Extrae current_user_id desde JWT token                       ‚îÇ
‚îÇ     - Valida order_id y template_id presentes                      ‚îÇ
‚îÇ     - Valida sections_data no est√© vac√≠o                           ‚îÇ
‚îÇ     - Query Order con filters:                                     ‚îÇ
‚îÇ       * id = order_id                                               ‚îÇ
‚îÇ       * user_id = current_user_id (seguridad)                      ‚îÇ
‚îÇ     - Valida Order.status == OrderStatus.PAID ‚ö†Ô∏è CR√çTICO           ‚îÇ
‚îÇ     - Valida Template existe en base de datos                      ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 8.3 Construye datos de Invitation:                                 ‚îÇ
‚îÇ     title = data.get('title')                                       ‚îÇ
‚îÇ     groom_name = data.get('groom_name')                             ‚îÇ
‚îÇ     bride_name = data.get('bride_name')                             ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ     # Auto-generar title si falta                                  ‚îÇ
‚îÇ     if not title and groom_name and bride_name:                    ‚îÇ
‚îÇ         title = f"Boda {groom_name} & {bride_name}"                ‚îÇ
‚îÇ     elif not title:                                                ‚îÇ
‚îÇ         title = f"Invitaci√≥n - Template {template.name}"           ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 8.4 Crea registro en tabla Invitation:                             ‚îÇ
‚îÇ     invitation = Invitation(                                        ‚îÇ
‚îÇ         user_id=current_user_id,                                    ‚îÇ
‚îÇ         order_id=order_id,                                          ‚îÇ
‚îÇ         title=title,                                                ‚îÇ
‚îÇ         groom_name=groom_name,                                      ‚îÇ
‚îÇ         bride_name=bride_name,                                      ‚îÇ
‚îÇ         wedding_date=data.get('event_date'),                        ‚îÇ
‚îÇ         plan_id=plan_id,                                            ‚îÇ
‚îÇ         status='active'                                             ‚îÇ
‚îÇ     )                                                               ‚îÇ
‚îÇ     db.session.add(invitation)                                      ‚îÇ
‚îÇ     db.session.flush()  # ‚Üê Obtiene invitation.id antes de commit  ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 8.5 Itera sobre sections_data y crea InvitationSectionsData:       ‚îÇ
‚îÇ     sections_created = 0                                            ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ     for section_type, variables in sections_data.items():          ‚îÇ
‚îÇ         # Skip secciones vac√≠as                                    ‚îÇ
‚îÇ         if not variables or len(variables) == 0:                   ‚îÇ
‚îÇ             continue                                                ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ         # Construir usage_stats para tracking                      ‚îÇ
‚îÇ         usage_stats = {                                             ‚îÇ
‚îÇ             "created_at": datetime.now(timezone.utc).isoformat(),   ‚îÇ
‚îÇ             "source": "checkout_post_payment",                      ‚îÇ
‚îÇ             "plan_type": "basic" if plan_id == 1 else "premium",   ‚îÇ
‚îÇ             "variables_count": len(variables),                      ‚îÇ
‚îÇ             "order_id": order_id                                    ‚îÇ
‚îÇ         }                                                           ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ         # Crear registro de secci√≥n                                ‚îÇ
‚îÇ         section = InvitationSectionsData(                           ‚îÇ
‚îÇ             invitation_id=invitation.id,  # ‚Üê Desde flush()        ‚îÇ
‚îÇ             user_id=current_user_id,                                ‚îÇ
‚îÇ             order_id=order_id,                                      ‚îÇ
‚îÇ             plan_id=plan_id,                                        ‚îÇ
‚îÇ             section_type=section_type,  # "hero", "welcome", etc.  ‚îÇ
‚îÇ             section_variant=f"{section_type}_1",  # Default        ‚îÇ
‚îÇ             category='weddings',  # Default                         ‚îÇ
‚îÇ             variables_json=variables,  # ‚Üê Nombres ORIGINALES      ‚îÇ
‚îÇ             usage_stats=usage_stats                                 ‚îÇ
‚îÇ         )                                                           ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ         db.session.add(section)                                     ‚îÇ
‚îÇ         sections_created += 1                                       ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 8.6 Commit transaction at√≥mica:                                    ‚îÇ
‚îÇ     db.session.commit()                                             ‚îÇ
‚îÇ     # ‚Üê Aqu√≠ se guardan Invitation + todas las secciones           ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 8.7 Backend retorna respuesta exitosa:                             ‚îÇ
‚îÇ     {                                                               ‚îÇ
‚îÇ       "success": true,                                              ‚îÇ
‚îÇ       "invitation_id": 456,                                         ‚îÇ
‚îÇ       "invitation_url": "/invitacion/456",                          ‚îÇ
‚îÇ       "sections_created": 4                                         ‚îÇ
‚îÇ     }                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PASO 9: LIMPIEZA Y REDIRECCI√ìN (Frontend)                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 9.1 Frontend recibe respuesta exitosa de creaci√≥n                  ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 9.2 Limpia localStorage:                                            ‚îÇ
‚îÇ     localStorage.removeItem('customizerData')                       ‚îÇ
‚îÇ     # ‚Üê Importante: Evita reutilizar datos viejos                  ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 9.3 Muestra notificaci√≥n de √©xito:                                 ‚îÇ
‚îÇ     toast.success('¬°Pago completado e invitaci√≥n creada!')          ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 9.4 Redirige a la invitaci√≥n creada:                               ‚îÇ
‚îÇ     router.push(invitationResponse.invitation_url)                  ‚îÇ
‚îÇ     # ‚Üí Usuario ve: /invitacion/456                                ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ 9.5 Usuario aterriza en TemplateBuilder:                           ‚îÇ
‚îÇ     - Carga datos desde InvitationSectionsData                     ‚îÇ
‚îÇ     - Renderiza template con personalizaci√≥n guardada              ‚îÇ
‚îÇ     - Usuario ve su invitaci√≥n finalizada                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MANEJO DE ERRORES                                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ERROR ESCENARIO 1: Creaci√≥n de invitaci√≥n falla                    ‚îÇ
‚îÇ - Pago YA est√° procesado (Order.status = PAID) ‚úÖ                  ‚îÇ
‚îÇ - Catch error en handlePaymentSuccess                              ‚îÇ
‚îÇ - Mostrar: "¬°Pago completado! Tu invitaci√≥n ser√° creada pronto."   ‚îÇ
‚îÇ - Redirigir a: /mi-cuenta/pedidos/{order_number}?success=true      ‚îÇ
‚îÇ - Admin puede crear invitaci√≥n manualmente desde el pedido         ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ ERROR ESCENARIO 2: No hay datos en localStorage                    ‚îÇ
‚îÇ - Validaci√≥n: Object.keys(customizerData).length === 0             ‚îÇ
‚îÇ - Mostrar: "¬°Pago completado exitosamente!"                        ‚îÇ
‚îÇ - Redirigir a: /mi-cuenta/pedidos/{order_number}?success=true      ‚îÇ
‚îÇ - Usuario compr√≥ template sin personalizar                         ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ ERROR ESCENARIO 3: Orden no est√° PAID                              ‚îÇ
‚îÇ - Backend valida: order.status != OrderStatus.PAID                 ‚îÇ
‚îÇ - Retorna 400: "La orden no est√° pagada"                           ‚îÇ
‚îÇ - Frontend no deber√≠a llegar aqu√≠ (pago se confirm√≥ antes)         ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îÇ ERROR ESCENARIO 4: Usuario no es due√±o de la orden                 ‚îÇ
‚îÇ - Backend valida: order.user_id != current_user_id                 ‚îÇ
‚îÇ - Retorna 404: "Orden no encontrada"                               ‚îÇ
‚îÇ - Previene acceso no autorizado a √≥rdenes ajenas                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

RESUMEN DEL FLUJO:
1. ‚úÖ Personalizaci√≥n ‚Üí localStorage (base64 para im√°genes)
2. ‚úÖ Carrito ‚Üí Solo template_id, NO personalizaci√≥n
3. ‚úÖ Checkout ‚Üí Crear Order PENDING
4. ‚úÖ Token ‚Üí Izipay formToken
5. ‚úÖ Pago ‚Üí Izipay procesa tarjeta
6. ‚úÖ Confirmar ‚Üí Order.status = PAID
7. ‚úÖ Crear ‚Üí Invitation + InvitationSectionsData (nombres originales)
8. ‚úÖ Limpiar ‚Üí localStorage.removeItem
9. ‚úÖ Redirigir ‚Üí /invitacion/{id}
```

### **IMPLEMENTACI√ìN BACKEND**

```python
# backend/api/invitations.py

@invitations_bp.route('/create-from-order', methods=['POST'])
@jwt_required()
def create_invitation_from_order():
    """
    POST /api/invitations/create-from-order

    WHY: Crear invitaci√≥n completa despu√©s de pago exitoso.
    Guarda datos de localStorage agrupados en InvitationSectionsData.

    PAYLOAD:
    {
        "order_id": 123,
        "template_id": 7,
        "plan_id": 1,  # 1=Basic, 2=Premium
        "sections_data": {
            "hero": {"groom_name": "Jefferson", "bride_name": "Rosmery", ...},
            "welcome": {"welcome_title": "¬°Nos Casamos!", ...},
            "gallery": {"gallery_images": [...]},
            ...
        },
        "event_date": "2024-12-15T17:00:00",  # Opcional
        "title": "Boda Jefferson & Rosmery",  # Opcional
        "groom_name": "Jefferson",  # Opcional
        "bride_name": "Rosmery"  # Opcional
    }

    RESPONSE:
    {
        "success": true,
        "invitation_id": 456,
        "invitation_url": "/invitacion/456"
    }
    """
    try:
        current_user_id = get_jwt_identity()
        data = request.get_json() or {}

        # VALIDACIONES
        order_id = data.get('order_id')
        template_id = data.get('template_id')
        plan_id = data.get('plan_id', 1)
        sections_data = data.get('sections_data', {})

        if not order_id or not template_id:
            return jsonify({'error': 'order_id y template_id son requeridos'}), 400

        if not sections_data or len(sections_data) == 0:
            return jsonify({'error': 'sections_data no puede estar vac√≠o'}), 400

        # Validar que order existe y est√° PAGADA
        order = Order.query.filter_by(
            id=order_id,
            user_id=current_user_id
        ).first()

        if not order:
            return jsonify({'error': 'Orden no encontrada'}), 404

        if order.status != OrderStatus.PAID:
            return jsonify({'error': 'La orden no est√° pagada'}), 400

        # Validar template existe
        template = Template.query.get(template_id)
        if not template:
            return jsonify({'error': 'Template no encontrado'}), 404

        # CREAR INVITACI√ìN
        title = data.get('title')
        groom_name = data.get('groom_name')
        bride_name = data.get('bride_name')

        # Auto-generar title si no viene
        if not title and groom_name and bride_name:
            title = f"Boda {groom_name} & {bride_name}"
        elif not title:
            title = f"Invitaci√≥n - Template {template.name}"

        invitation = Invitation(
            user_id=current_user_id,
            order_id=order_id,
            title=title,
            groom_name=groom_name,
            bride_name=bride_name,
            wedding_date=data.get('event_date'),
            plan_id=plan_id,
            status='active'
        )

        db.session.add(invitation)
        db.session.flush()  # Get invitation.id before commit

        # CREAR SECCIONES
        sections_created = 0

        for section_type, variables in sections_data.items():
            # Skip si no hay variables
            if not variables or len(variables) == 0:
                continue

            # Crear usage_stats
            usage_stats = {
                "created_at": datetime.now(timezone.utc).isoformat(),
                "source": "checkout_post_payment",
                "plan_type": "basic" if plan_id == 1 else "premium",
                "variables_count": len(variables),
                "order_id": order_id
            }

            section = InvitationSectionsData(
                invitation_id=invitation.id,
                user_id=current_user_id,
                order_id=order_id,
                plan_id=plan_id,
                section_type=section_type,
                section_variant=f"{section_type}_1",  # Default variant
                category='weddings',  # Default category
                variables_json=variables,  # ‚Üê Mantiene nombres originales
                usage_stats=usage_stats
            )

            db.session.add(section)
            sections_created += 1

        db.session.commit()

        return jsonify({
            'success': True,
            'invitation_id': invitation.id,
            'invitation_url': f'/invitacion/{invitation.id}',
            'sections_created': sections_created
        }), 201

    except Exception as e:
        db.session.rollback()
        return jsonify({'error': str(e)}), 500
```

### **IMPLEMENTACI√ìN FRONTEND**

```typescript
// frontend/src/lib/api/invitations.ts

/**
 * Agrupar datos planos de localStorage por secciones
 */
export function groupCustomizerDataBySections(flatData: Record<string, any>): Record<string, any> {
  const sectionsData: Record<string, any> = {};

  // Secciones conocidas del template
  const sectionTypes = ['hero', 'welcome', 'couple', 'countdown', 'story', 'video', 'gallery', 'footer'];

  // Inicializar secciones vac√≠as
  sectionTypes.forEach(section => {
    sectionsData[section] = {};
  });

  // Agrupar variables por prefijo
  Object.entries(flatData).forEach(([key, value]) => {
    if (value === null || value === undefined || value === '') {
      return;
    }

    // Buscar secci√≥n por prefijo
    const matchedSection = sectionTypes.find(section => key.startsWith(`${section}_`));

    if (matchedSection) {
      // Mantener nombre original (con prefijo)
      sectionsData[matchedSection][key] = value;
    } else {
      // Variables sin prefijo van a 'general'
      if (!sectionsData.general) {
        sectionsData.general = {};
      }
      sectionsData.general[key] = value;
    }
  });

  // Remover secciones sin datos
  Object.keys(sectionsData).forEach(section => {
    if (Object.keys(sectionsData[section]).length === 0) {
      delete sectionsData[section];
    }
  });

  return sectionsData;
}

/**
 * Extraer metadatos de los datos del customizer
 */
export function extractInvitationMetadata(customizerData: Record<string, any>) {
  return {
    event_date: customizerData.hero_date || customizerData.countdown_date || undefined,
    title: customizerData.hero_title || undefined,
    groom_name: customizerData.hero_groom_name || customizerData.couple_groom_name || undefined,
    bride_name: customizerData.hero_bride_name || customizerData.couple_bride_name || undefined
  };
}

/**
 * Crear invitaci√≥n desde orden despu√©s de pago exitoso
 */
export async function createInvitationFromOrder(
  orderId: number,
  templateId: number,
  customizerData: Record<string, any>,
  additionalData?: {
    event_date?: string;
    title?: string;
    groom_name?: string;
    bride_name?: string;
  }
): Promise<{ success: boolean; invitation_id: number; invitation_url: string }> {
  try {
    // Transformar datos planos a agrupados
    const sectionsData = groupCustomizerDataBySections(customizerData);

    // Determinar plan_id
    let planId = 1; // Default: Plan B√°sico
    if (customizerData.template?.plan_id) {
      planId = customizerData.template.plan_id;
    } else if (customizerData.plan_id) {
      planId = customizerData.plan_id;
    }

    // Construir payload
    const payload = {
      order_id: orderId,
      template_id: templateId,
      plan_id: planId,
      sections_data: sectionsData,
      ...additionalData
    };

    // Llamar al backend
    const response = await apiClient.post('/invitations/create-from-order', payload);

    return response.data;

  } catch (error: any) {
    console.error('Error creating invitation from order:', error);
    throw new Error(
      error.response?.data?.error || 'Failed to create invitation from order'
    );
  }
}
```

### **INTEGRACI√ìN EN CHECKOUT**

```typescript
// frontend/src/app/checkout/page.tsx

import { createInvitationFromOrder, extractInvitationMetadata } from '@/lib/api/invitations';

const handlePaymentSuccess = async (paymentResult: any) => {
  try {
    if (!currentOrder) {
      throw new Error('No order found');
    }

    // 1. Procesar pago
    await paymentsApi.processPayment({
      order_id: currentOrder.id,
      payment_result: {
        status: 'SUCCESS',
        transaction_id: currentOrder.order_number,
        izipay_data: paymentResult,
      },
    });

    // 2. Guardar invitaci√≥n desde localStorage
    try {
      const customizerData = JSON.parse(localStorage.getItem('customizerData') || '{}');
      const templateId = customizerData.template_id || cart?.items?.[0]?.template_id;

      if (templateId && Object.keys(customizerData).length > 0) {
        const metadata = extractInvitationMetadata(customizerData);

        const invitationResponse = await createInvitationFromOrder(
          currentOrder.id,
          templateId,
          customizerData,
          metadata
        );

        // Limpiar localStorage
        localStorage.removeItem('customizerData');

        toast.success('¬°Pago completado e invitaci√≥n creada exitosamente!');
        router.push(invitationResponse.invitation_url);
      } else {
        // Sin datos del customizer
        toast.success('¬°Pago completado exitosamente!');
        router.push(`/mi-cuenta/pedidos/${currentOrder.order_number}?success=true`);
      }
    } catch (invitationError: any) {
      console.error('Error creating invitation:', invitationError);
      // Pago exitoso pero fallo creaci√≥n - redirigir a orden
      toast.success('¬°Pago completado! Tu invitaci√≥n ser√° creada pronto.');
      router.push(`/mi-cuenta/pedidos/${currentOrder.order_number}?success=true`);
    }

  } catch (error: any) {
    console.error('Error processing payment:', error);
    toast.error('Error confirmando el pago. Contacta con soporte.');
  }
};
```

### **EJEMPLO DE DATOS REALES**

#### **localStorage Antes del Pago**
```json
{
  "customizerData": {
    "template_id": 7,
    "plan_id": 1,
    "hero_groom_name": "Jefferson",
    "hero_bride_name": "Rosmery",
    "hero_date": "2024-12-15T17:00:00",
    "hero_imageUrl": "data:image/png;base64,iVBORw0KGgoAAAANSUhEU...",
    "welcome_title": "¬°Nos Casamos!",
    "welcome_description": "Con inmensa alegr√≠a...",
    "gallery_images": [
      {"url": "data:image/png;base64,...", "alt": "Foto 1"},
      {"url": "data:image/png;base64,...", "alt": "Foto 2"}
    ],
    "countdown_date": "2024-12-15T17:00:00"
  },
  "touchedFields": {
    "hero_groom_name": true,
    "hero_bride_name": true,
    "welcome_title": true
  }
}
```

#### **Payload Enviado al Backend**
```json
{
  "order_id": 123,
  "template_id": 7,
  "plan_id": 1,
  "sections_data": {
    "hero": {
      "hero_groom_name": "Jefferson",
      "hero_bride_name": "Rosmery",
      "hero_date": "2024-12-15T17:00:00",
      "hero_imageUrl": "data:image/png;base64,iVBORw0KGgoAAAANSUhEU..."
    },
    "welcome": {
      "welcome_title": "¬°Nos Casamos!",
      "welcome_description": "Con inmensa alegr√≠a..."
    },
    "gallery": {
      "gallery_images": [
        {"url": "data:image/png;base64,...", "alt": "Foto 1"},
        {"url": "data:image/png;base64,...", "alt": "Foto 2"}
      ]
    },
    "countdown": {
      "countdown_date": "2024-12-15T17:00:00"
    }
  },
  "event_date": "2024-12-15T17:00:00",
  "groom_name": "Jefferson",
  "bride_name": "Rosmery"
}
```

#### **Datos Guardados en Base de Datos**

**Tabla: `Invitation`**
```sql
id: 456
user_id: 14
order_id: 123
title: "Boda Jefferson & Rosmery"
groom_name: "Jefferson"
bride_name: "Rosmery"
wedding_date: "2024-12-15 17:00:00"
plan_id: 1
status: "active"
```

**Tabla: `InvitationSectionsData` (4 registros creados)**

```sql
-- Registro 1: Hero
id: 1001
invitation_id: 456
user_id: 14
order_id: 123
plan_id: 1
section_type: "hero"
section_variant: "hero_1"
category: "weddings"
variables_json: {
  "hero_groom_name": "Jefferson",
  "hero_bride_name": "Rosmery",
  "hero_date": "2024-12-15T17:00:00",
  "hero_imageUrl": "data:image/png;base64,..."
}
usage_stats: {
  "created_at": "2025-01-24T15:30:00Z",
  "source": "checkout_post_payment",
  "plan_type": "basic",
  "variables_count": 4,
  "order_id": 123
}

-- Registro 2: Welcome
id: 1002
section_type: "welcome"
variables_json: {
  "welcome_title": "¬°Nos Casamos!",
  "welcome_description": "Con inmensa alegr√≠a..."
}

-- Registro 3: Gallery
id: 1003
section_type: "gallery"
variables_json: {
  "gallery_images": [...]
}

-- Registro 4: Countdown
id: 1004
section_type: "countdown"
variables_json: {
  "countdown_date": "2024-12-15T17:00:00"
}
```

### **PUNTOS CLAVE**

1. **‚úÖ Mantiene nombres originales** - No se renombran variables
2. **‚úÖ Agrupa por prefijos** - `hero_`, `welcome_`, etc.
3. **‚úÖ Base64 para im√°genes** - Compatible con PDF generation
4. **‚úÖ Orden pagada primero** - Validaci√≥n de `OrderStatus.PAID`
5. **‚úÖ Atomic transaction** - Todo o nada con `db.session`
6. **‚úÖ Error handling completo** - Fallbacks si falla creaci√≥n
7. **‚úÖ localStorage cleanup** - Limpia datos despu√©s de guardar
8. **‚úÖ Redirecci√≥n autom√°tica** - Usuario ve su invitaci√≥n nueva

### **VENTAJAS DEL ENFOQUE**

- **Seguro**: Pago validado antes de crear invitaci√≥n
- **Autom√°tico**: No requiere intervenci√≥n manual
- **Robusto**: Maneja errores sin perder el pago
- **Transparente**: Usuario ve resultado inmediatamente
- **Escalable**: Funciona con cualquier template/plan

### **FLUJO DE ERROR RECOVERY**

```
Si PAGO exitoso pero CREACI√ìN falla:
1. Pago ya procesado ‚úÖ
2. Order status = PAID ‚úÖ
3. Usuario redirigido a Order Confirmation
4. Admin puede crear invitaci√≥n manualmente desde Order
5. O sistema puede reintentar autom√°ticamente
```

---

**üéØ RESUMEN DE CASOS DE USO:**

1. **‚úÖ Wedding B√°sico** - Registro est√°ndar con validaciones
2. **‚úÖ Wedding Premium** - Features avanzadas y custom elements
3. **‚úÖ Kids Birthday** - Diferente categor√≠a y estructura
4. **‚úÖ Actualizaci√≥n Incremental** - Updates parciales
5. **‚úÖ Migraci√≥n Legacy** - Transici√≥n desde sistema EAV
6. **‚úÖ Analytics Avanzados** - Business Intelligence
7. **‚úÖ Validaci√≥n Robusta** - Manejo de errores en producci√≥n
8. **‚úÖ Testing Completo** - Cobertura de casos edge
9. **‚úÖ localStorage Integration** - Transformaci√≥n de datos del frontend
10. **‚úÖ Checkout Post-Payment** - Creaci√≥n autom√°tica despu√©s de pago exitoso

**Esta documentaci√≥n cubre todos los escenarios reales de uso del sistema** üöÄ